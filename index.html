<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StockMind AI</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg: #07090d;
  --bg2: #0d1117;
  --bg3: #161b22;
  --brd: #21262d;
  --acc: #00d4aa;
  --ac3: #7c3aed;
  --tx: #e6edf3;
  --tx2: #8b949e;
  --tx3: #484f58;
  --up: #3fb950;
  --dn: #f85149;
  --r: 12px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--tx); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow-x: hidden; }

/* HEADER */
header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(7,9,13,.95); backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--brd);
  display: flex; align-items: center; padding: 0 28px; height: 56px; gap: 20px;
}
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.55rem; letter-spacing: 2px; color: var(--tx); flex-shrink: 0; }
.logo span { color: var(--acc); }
.tb { flex: 1; overflow: hidden; position: relative; }
.tb::before, .tb::after { content: ''; position: absolute; top: 0; bottom: 0; width: 48px; z-index: 2; pointer-events: none; }
.tb::before { left: 0; background: linear-gradient(to right, var(--bg), transparent); }
.tb::after { right: 0; background: linear-gradient(to left, var(--bg), transparent); }
.tb-track { display: flex; gap: 32px; white-space: nowrap; animation: ticker 40s linear infinite; }
.tb-track:hover { animation-play-state: paused; }
@keyframes ticker { from { transform: translateX(0); } to { transform: translateX(-50%); } }
.ti { font-family: 'JetBrains Mono', monospace; font-size: .76rem; color: var(--tx2); display: inline-flex; align-items: center; gap: 7px; cursor: pointer; flex-shrink: 0; }
.ti:hover { color: var(--tx); }
.ti b { color: var(--tx); }
.up { color: var(--up); }
.dn { color: var(--dn); }
.ti-ph { color: var(--tx3); font-family: 'JetBrains Mono', monospace; font-size: .76rem; }

/* MAIN */
main { max-width: 1100px; margin: 0 auto; padding: 0 24px 80px; position: relative; z-index: 1; }

/* HERO */
.hero { padding: 74px 0 52px; text-align: center; }
.hero-badge { display: inline-block; margin-bottom: 24px; font-family: 'JetBrains Mono', monospace; font-size: .72rem; letter-spacing: 3px; text-transform: uppercase; color: var(--acc); border: 1px solid rgba(0,212,170,.28); padding: 4px 16px; border-radius: 100px; }
.hero h1 { font-family: 'Bebas Neue', sans-serif; font-size: clamp(2.8rem, 8vw, 5.3rem); line-height: 1.06; letter-spacing: 1px; margin-bottom: 16px; }
.hero h1 em { font-style: normal; color: var(--acc); }
.hero-sub { color: var(--tx2); font-size: .97rem; line-height: 1.9; margin-bottom: 40px; }

/* SEARCH */
.sw { position: relative; max-width: 700px; margin: 0 auto 22px; }
.sb { display: flex; align-items: center; background: var(--bg3); border: 1.5px solid var(--brd); border-radius: 14px; padding: 6px 6px 6px 20px; gap: 10px; transition: border-color .25s, box-shadow .25s; }
.sb:focus-within { border-color: var(--acc); box-shadow: 0 0 0 3px rgba(0,212,170,.1), 0 8px 28px rgba(0,0,0,.4); }
.si { width: 20px; height: 20px; color: var(--tx3); flex-shrink: 0; }
#q { flex: 1; background: none; border: none; outline: none; color: var(--tx); font-family: 'Noto Sans KR', sans-serif; font-size: 1rem; padding: 10px 0; }
#q::placeholder { color: var(--tx3); }
#btn {
  background: var(--acc); color: var(--bg); border: none; border-radius: 10px;
  padding: 12px 26px; font-family: 'Noto Sans KR', sans-serif; font-weight: 700; font-size: .9rem;
  cursor: pointer; white-space: nowrap; transition: background .2s, transform .15s;
}
#btn:hover { background: #00c09a; transform: translateY(-1px); }
#btn:active { transform: none; }
#btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

/* SUGGEST */
#sug { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: var(--bg3); border: 1px solid var(--brd); border-radius: 12px; overflow: hidden; z-index: 60; display: none; box-shadow: 0 16px 48px rgba(0,0,0,.6); }
#sug.open { display: block; }
.sg { display: flex; justify-content: space-between; align-items: center; padding: 11px 18px; cursor: pointer; border-bottom: 1px solid var(--brd); transition: background .15s; }
.sg:last-child { border-bottom: none; }
.sg:hover { background: rgba(255,255,255,.04); }
.sg-name { font-size: .92rem; font-weight: 500; }
.sg-sub { font-family: 'JetBrains Mono', monospace; font-size: .7rem; color: var(--tx2); margin-top: 2px; }
.sg-badge { font-size: .67rem; padding: 3px 9px; border-radius: 100px; font-weight: 700; flex-shrink: 0; }
.sg-badge.k { background: rgba(124,58,237,.18); color: #a78bfa; }
.sg-badge.q { background: rgba(0,212,170,.14); color: var(--acc); }
.sg-badge.u { background: rgba(255,107,53,.14); color: #ff6b35; }

/* CHIPS */
.chips { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.chip { background: var(--bg3); border: 1px solid var(--brd); color: var(--tx2); border-radius: 100px; padding: 6px 18px; font-family: 'JetBrains Mono', monospace; font-size: .78rem; cursor: pointer; transition: all .2s; }
.chip:hover, .chip.on { background: var(--acc); color: var(--bg); border-color: var(--acc); }

/* BANNER */
#banner { display: none; margin-top: 20px; border-radius: var(--r); padding: 22px 26px; }
#banner.err { background: rgba(248,81,73,.07); border: 1px solid rgba(248,81,73,.28); }
#banner h3 { color: var(--dn); font-size: .95rem; margin-bottom: 10px; }
#banner p { color: var(--tx2); font-size: .86rem; line-height: 1.9; }
#banner code { color: var(--acc); font-family: 'JetBrains Mono', monospace; background: rgba(0,212,170,.08); padding: 2px 6px; border-radius: 4px; }

/* RESULT */
.rs { margin-top: 16px; animation: fadeUp .4s ease both; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: none; } }
.rh { background: var(--bg2); border: 1px solid var(--brd); border-radius: var(--r); padding: 26px 30px; margin-bottom: 16px; position: relative; overflow: hidden; }
.rh::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(to right, var(--acc), var(--ac3)); }
.rm { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
.rm-mkt { font-family: 'JetBrains Mono', monospace; font-size: .7rem; padding: 3px 10px; border-radius: 100px; background: rgba(0,212,170,.13); color: var(--acc); font-weight: 700; }
.rm-time { font-family: 'JetBrains Mono', monospace; font-size: .7rem; color: var(--tx3); }
.rn { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
.rn h2 { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 1px; }
.rbadge { font-family: 'JetBrains Mono', monospace; font-size: .82rem; color: var(--tx2); background: var(--bg3); border: 1px solid var(--brd); padding: 3px 12px; border-radius: 8px; }
.pb { display: flex; align-items: baseline; gap: 14px; flex-wrap: wrap; }
.price-main { font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; }
.price-chg { font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 700; }
.price-chg.up { color: var(--up); }
.price-chg.dn { color: var(--dn); }

/* DATA GRID */
.dg { display: grid; grid-template-columns: 1fr 310px; gap: 16px; margin-bottom: 16px; }
@media (max-width: 760px) { .dg { grid-template-columns: 1fr; } }
.cc, .sc { background: var(--bg2); border: 1px solid var(--brd); border-radius: var(--r); padding: 22px; }
.card-label { font-family: 'JetBrains Mono', monospace; font-size: .7rem; letter-spacing: 2px; text-transform: uppercase; color: var(--tx3); margin-bottom: 16px; }
#mychart { width: 100% !important; height: 220px !important; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; }
.stat-item { background: var(--bg3); border-radius: 8px; padding: 12px; }
.stat-label { font-family: 'JetBrains Mono', monospace; font-size: .6rem; letter-spacing: 1px; text-transform: uppercase; color: var(--tx3); margin-bottom: 5px; }
.stat-val { font-family: 'JetBrains Mono', monospace; font-size: .9rem; font-weight: 700; color: var(--tx); }

/* AI PANEL */
.ap { background: var(--bg2); border: 1px solid var(--brd); border-radius: var(--r); padding: 26px 30px; position: relative; overflow: hidden; }
.ap::before { content: ''; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(ellipse at top left, rgba(124,58,237,.05), transparent 55%); }
.ap-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.ap-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: var(--acc); }
.ap-badge { font-family: 'JetBrains Mono', monospace; font-size: .67rem; color: var(--tx3); padding: 3px 10px; border: 1px solid var(--brd); border-radius: 100px; }
.ai-loading { display: flex; align-items: center; gap: 13px; padding: 26px 0; color: var(--tx2); font-size: .87rem; }
.spinner { width: 32px; height: 32px; flex-shrink: 0; border: 3px solid transparent; border-top-color: var(--acc); border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* AI CONTENT */
.ai-sec { margin-bottom: 24px; }
.ai-sec:last-child { margin-bottom: 0; }
.ai-sec-title { font-family: 'JetBrains Mono', monospace; font-size: .7rem; letter-spacing: 2px; text-transform: uppercase; color: var(--acc); margin-bottom: 11px; padding-bottom: 7px; border-bottom: 1px solid rgba(0,212,170,.17); }
.verdict-row { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.verdict-chip { padding: 7px 18px; border-radius: 100px; font-weight: 700; font-size: .85rem; font-family: 'JetBrains Mono', monospace; }
.vc-buy  { background: rgba(63,185,80,.13);  color: var(--up);   border: 1px solid rgba(63,185,80,.27);  }
.vc-sell { background: rgba(248,81,73,.13);  color: var(--dn);   border: 1px solid rgba(248,81,73,.27); }
.vc-hold { background: rgba(255,179,0,.13);  color: #ffb300;     border: 1px solid rgba(255,179,0,.27); }
.vc-watch{ background: rgba(124,58,237,.13); color: #a78bfa;     border: 1px solid rgba(124,58,237,.27);}
.vc-low  { background: rgba(63,185,80,.1);   color: var(--up);   border: 1px solid rgba(63,185,80,.2);  }
.vc-mid  { background: rgba(255,179,0,.1);   color: #ffb300;     border: 1px solid rgba(255,179,0,.2);  }
.vc-high { background: rgba(248,81,73,.1);   color: var(--dn);   border: 1px solid rgba(248,81,73,.2);  }
.strat-row { display: flex; gap: 9px; flex-wrap: wrap; margin: 11px 0; }
.strat-box { flex: 1; min-width: 105px; background: var(--bg3); border-radius: 10px; padding: 13px; text-align: center; }
.strat-label { font-family: 'JetBrains Mono', monospace; font-size: .6rem; color: var(--tx3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.strat-val { font-family: 'JetBrains Mono', monospace; font-size: .97rem; font-weight: 700; }
.strat-box.buy  .strat-val { color: var(--up);   }
.strat-box.sell .strat-val { color: var(--dn);   }
.strat-box.stop .strat-val { color: #ff6b35;     }
.strat-box.mid  .strat-val { color: var(--acc);  }
.risk-bar-row { display: flex; align-items: center; gap: 10px; margin: 11px 0; }
.risk-label { font-family: 'JetBrains Mono', monospace; font-size: .7rem; color: var(--tx2); width: 52px; }
.risk-track { flex: 1; height: 7px; background: var(--bg3); border-radius: 100px; overflow: hidden; }
.risk-fill { height: 100%; border-radius: 100px; transition: width 1.3s ease; }
.risk-fill.low  { background: var(--up); }
.risk-fill.mid  { background: #ffb300; }
.risk-fill.high { background: var(--dn); }
.risk-pct { font-family: 'JetBrains Mono', monospace; font-size: .7rem; color: var(--tx2); width: 32px; text-align: right; }
.ai-text { color: #c9d1d9; line-height: 1.9; margin-top: 12px; font-size: .93rem; }
.ai-sub-text { color: var(--tx2); font-size: .85rem; margin-top: 6px; line-height: 1.8; }

/* POPULAR */
.ps { margin-top: 58px; }
.ps-label { font-family: 'JetBrains Mono', monospace; font-size: .7rem; letter-spacing: 3px; text-transform: uppercase; color: var(--tx3); margin-bottom: 16px; }
.pop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(195px, 1fr)); gap: 12px; }
.pop-card { background: var(--bg2); border: 1px solid var(--brd); border-radius: var(--r); padding: 18px; cursor: pointer; transition: border-color .2s, transform .2s, box-shadow .2s; position: relative; overflow: hidden; }
.pop-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(to right, var(--acc), var(--ac3)); transform: scaleX(0); transition: transform .3s; }
.pop-card:hover { border-color: rgba(0,212,170,.46); transform: translateY(-3px); box-shadow: 0 10px 26px rgba(0,0,0,.4); }
.pop-card:hover::after { transform: scaleX(1); }
.pop-sym { font-family: 'JetBrains Mono', monospace; font-size: .68rem; color: var(--tx3); margin-bottom: 4px; }
.pop-name { font-weight: 700; font-size: .9rem; margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pop-price { font-family: 'JetBrains Mono', monospace; font-size: 1.06rem; font-weight: 700; margin-bottom: 3px; }
.pop-chg { font-family: 'JetBrains Mono', monospace; font-size: .77rem; font-weight: 700; }
.pop-chg.up { color: var(--up); }
.pop-chg.dn { color: var(--dn); }
.pop-chg.na { color: var(--tx3); }
.skel { height: 116px; border-radius: var(--r); border: 1px solid var(--brd); background: linear-gradient(90deg, var(--bg2) 0%, var(--bg3) 50%, var(--bg2) 100%); background-size: 200% 100%; animation: skel 1.4s infinite; }
@keyframes skel { to { background-position: -200% 0; } }

/* FOOTER */
footer { text-align: center; padding: 28px 24px; border-top: 1px solid var(--brd); color: var(--tx3); font-size: .76rem; line-height: 2.1; }
footer .mono { font-family: 'JetBrains Mono', monospace; font-size: .67rem; }

/* TOAST */
.toast { position: fixed; bottom: 26px; left: 50%; transform: translateX(-50%); background: #0d1117; border: 1px solid var(--dn); color: var(--dn); padding: 12px 24px; border-radius: 12px; font-size: .86rem; z-index: 9999; box-shadow: 0 8px 28px rgba(0,0,0,.6); max-width: 88vw; text-align: center; line-height: 1.6; animation: fadeUp .3s ease; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--brd); border-radius: 3px; }

@media (max-width: 560px) {
  header { padding: 0 14px; }
  main { padding: 0 14px 56px; }
  .hero { padding: 42px 0 34px; }
  .rh, .ap { padding: 16px; }
  .price-main { font-size: 1.9rem; }
  #btn { padding: 12px 14px; font-size: .83rem; }
}
</style>
</head>
<body>

<header>
  <div class="logo">STOCK<span>MIND</span></div>
  <div class="tb">
    <div class="tb-track" id="tbTrack">
      <span class="ti-ph">ì‹œì¥ ë°ì´í„° ë¡œë”© ì¤‘...</span>
    </div>
  </div>
</header>

<main>
  <section class="hero">
    <div class="hero-badge">AI ì£¼ì‹ ë¶„ì„ í”Œë«í¼</div>
    <h1>ì£¼ì‹ì„ ê²€ìƒ‰í•˜ê³ <br><em>AIì˜ ëˆˆ</em>ìœ¼ë¡œ ë³´ë¼</h1>
    <p class="hero-sub">ì½”ìŠ¤í”¼ Â· ì½”ìŠ¤ë‹¥ Â· ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ë¶„ì„<br>ì–¸ì œ ì‚¬ê³  íŒ”ì§€, AIê°€ êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</p>
    <div class="sw">
      <div class="sb">
        <svg class="si" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input id="q" type="text" placeholder="ì‚¼ì„±ì „ì, AAPL, ì¹´ì¹´ì˜¤, Tesla, 005930..." autocomplete="off" spellcheck="false">
        <button id="btn">ë¶„ì„í•˜ê¸°</button>
      </div>
      <div id="sug"></div>
    </div>
    <div class="chips">
      <button class="chip on">ì „ì²´</button>
      <button class="chip">KOSPI</button>
      <button class="chip">KOSDAQ</button>
      <button class="chip">ë¯¸êµ­</button>
    </div>
  </section>

  <div id="banner"></div>

  <section id="rs" style="display:none">
    <div class="rh">
      <div class="rm">
        <span class="rm-mkt" id="rMkt"></span>
        <span class="rm-time" id="rTime"></span>
      </div>
      <div class="rn">
        <h2 id="rName"></h2>
        <span class="rbadge" id="rTicker"></span>
      </div>
      <div class="pb">
        <span class="price-main" id="rPrice"></span>
        <span class="price-chg" id="rChange"></span>
      </div>
    </div>

    <div class="dg">
      <div class="cc">
        <div class="card-label">ê°€ê²© ì°¨íŠ¸ (ìµœê·¼ 30ì¼)</div>
        <canvas id="mychart"></canvas>
      </div>
      <div class="sc">
        <div class="card-label">í•µì‹¬ ì§€í‘œ</div>
        <div class="stats-grid" id="statsGrid"></div>
      </div>
    </div>

    <div class="ap">
      <div class="ap-head">
        <div class="ap-title">
          <svg viewBox="0 0 24 24" fill="currentColor" width="17" height="17">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
          </svg>
          AI ë¶„ì„ ë¦¬í¬íŠ¸
        </div>
        <span class="ap-badge">Claude AI</span>
      </div>
      <div class="ai-loading" id="aiLoad">
        <div class="spinner"></div>
        <span>AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
      </div>
      <div id="aiContent" style="display:none"></div>
    </div>
  </section>

  <section class="ps">
    <div class="ps-label">ì¸ê¸° ì¢…ëª©</div>
    <div class="pop-grid" id="popGrid">
      <div class="skel"></div>
      <div class="skel"></div>
      <div class="skel"></div>
      <div class="skel"></div>
      <div class="skel"></div>
      <div class="skel"></div>
    </div>
  </section>
</main>

<footer>
  <p>StockMind AI Â· íˆ¬ìëŠ” ë³¸ì¸ ì±…ì„ì…ë‹ˆë‹¤ Â· ì •ë³´ ì œê³µ ëª©ì ì´ë©° íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤</p>
  <p class="mono">Naver Finance Â· Yahoo Finance Â· Claude AI Â· Cloudflare Pages</p>
</footer>

<script>
(function() {
  'use strict';

  /* â”€â”€ ì¢…ëª© DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var DB = [
    {c:'005930.KS', m:'KOSPI',  n:'ì‚¼ì„±ì „ì',        e:'Samsung Electronics'},
    {c:'000660.KS', m:'KOSPI',  n:'SKí•˜ì´ë‹‰ìŠ¤',       e:'SK Hynix'},
    {c:'035420.KS', m:'KOSPI',  n:'NAVER',            e:'NAVER Corp'},
    {c:'035720.KS', m:'KOSPI',  n:'ì¹´ì¹´ì˜¤',           e:'Kakao'},
    {c:'005380.KS', m:'KOSPI',  n:'í˜„ëŒ€ìë™ì°¨',       e:'Hyundai Motor'},
    {c:'000270.KS', m:'KOSPI',  n:'ê¸°ì•„',             e:'Kia'},
    {c:'051910.KS', m:'KOSPI',  n:'LGí™”í•™',           e:'LG Chem'},
    {c:'005490.KS', m:'KOSPI',  n:'POSCOí™€ë”©ìŠ¤',      e:'POSCO Holdings'},
    {c:'207940.KS', m:'KOSPI',  n:'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', e:'Samsung Biologics'},
    {c:'068270.KS', m:'KOSPI',  n:'ì…€íŠ¸ë¦¬ì˜¨',         e:'Celltrion'},
    {c:'323410.KS', m:'KOSPI',  n:'ì¹´ì¹´ì˜¤ë±…í¬',       e:'KakaoBank'},
    {c:'259960.KS', m:'KOSPI',  n:'í¬ë˜í”„í†¤',         e:'Krafton'},
    {c:'352820.KS', m:'KOSPI',  n:'í•˜ì´ë¸Œ',           e:'HYBE'},
    {c:'036570.KS', m:'KOSPI',  n:'ì—”ì”¨ì†Œí”„íŠ¸',       e:'NCSoft'},
    {c:'251270.KS', m:'KOSPI',  n:'ë„·ë§ˆë¸”',           e:'Netmarble'},
    {c:'090430.KS', m:'KOSPI',  n:'ì•„ëª¨ë ˆí¼ì‹œí”½',     e:'AmorePacific'},
    {c:'030200.KS', m:'KOSPI',  n:'KT',               e:'KT Corp'},
    {c:'017670.KS', m:'KOSPI',  n:'SKí…”ë ˆì½¤',         e:'SK Telecom'},
    {c:'066570.KS', m:'KOSPI',  n:'LGì „ì',           e:'LG Electronics'},
    {c:'055550.KS', m:'KOSPI',  n:'ì‹ í•œì§€ì£¼',         e:'Shinhan Financial'},
    {c:'105560.KS', m:'KOSPI',  n:'KBê¸ˆìœµ',           e:'KB Financial'},
    {c:'086790.KS', m:'KOSPI',  n:'í•˜ë‚˜ê¸ˆìœµì§€ì£¼',     e:'Hana Financial'},
    {c:'015760.KS', m:'KOSPI',  n:'í•œêµ­ì „ë ¥',         e:'Korea Electric Power'},
    {c:'034020.KS', m:'KOSPI',  n:'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°',   e:'Doosan Enerbility'},
    {c:'003550.KS', m:'KOSPI',  n:'LG',               e:'LG Corp'},
    {c:'015360.KS', m:'KOSPI',  n:'ì´ê±´í™€ë”©ìŠ¤',       e:'Ikon Holdings'},
    {c:'003490.KS', m:'KOSPI',  n:'ëŒ€í•œí•­ê³µ',         e:'Korean Air'},
    {c:'000100.KS', m:'KOSPI',  n:'ìœ í•œì–‘í–‰',         e:'Yuhan Corp'},
    {c:'009150.KS', m:'KOSPI',  n:'ì‚¼ì„±ì „ê¸°',         e:'Samsung Electro'},
    {c:'010130.KS', m:'KOSPI',  n:'ê³ ë ¤ì•„ì—°',         e:'Korea Zinc'},
    {c:'012330.KS', m:'KOSPI',  n:'í˜„ëŒ€ëª¨ë¹„ìŠ¤',       e:'Hyundai Mobis'},
    {c:'247540.KQ', m:'KOSDAQ', n:'ì—ì½”í”„ë¡œë¹„ì— ',     e:'EcoPro BM'},
    {c:'086520.KQ', m:'KOSDAQ', n:'ì—ì½”í”„ë¡œ',         e:'EcoPro'},
    {c:'091990.KQ', m:'KOSDAQ', n:'ì…€íŠ¸ë¦¬ì˜¨í—¬ìŠ¤ì¼€ì–´', e:'Celltrion Healthcare'},
    {c:'293490.KQ', m:'KOSDAQ', n:'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ',     e:'Kakao Games'},
    {c:'263750.KQ', m:'KOSDAQ', n:'í„ì–´ë¹„ìŠ¤',         e:'Pearl Abyss'},
    {c:'041510.KQ', m:'KOSDAQ', n:'ì—ìŠ¤ì— ',           e:'SM Entertainment'},
    {c:'AAPL',      m:'NASDAQ', n:'Apple',             e:'Apple Inc'},
    {c:'MSFT',      m:'NASDAQ', n:'Microsoft',         e:'Microsoft Corp'},
    {c:'GOOGL',     m:'NASDAQ', n:'Alphabet',          e:'Alphabet Inc'},
    {c:'AMZN',      m:'NASDAQ', n:'Amazon',            e:'Amazon.com'},
    {c:'NVDA',      m:'NASDAQ', n:'NVIDIA',            e:'NVIDIA Corp'},
    {c:'META',      m:'NASDAQ', n:'Meta',              e:'Meta Platforms'},
    {c:'TSLA',      m:'NASDAQ', n:'Tesla',             e:'Tesla Inc'},
    {c:'TSM',       m:'NYSE',   n:'TSMC',              e:'Taiwan Semiconductor'},
    {c:'AVGO',      m:'NASDAQ', n:'Broadcom',          e:'Broadcom Inc'},
    {c:'NFLX',      m:'NASDAQ', n:'Netflix',           e:'Netflix Inc'},
    {c:'AMD',       m:'NASDAQ', n:'AMD',               e:'Advanced Micro Devices'},
    {c:'INTC',      m:'NASDAQ', n:'Intel',             e:'Intel Corp'},
    {c:'DIS',       m:'NYSE',   n:'Disney',            e:'Walt Disney'},
    {c:'JPM',       m:'NYSE',   n:'JP Morgan',         e:'JPMorgan Chase'},
    {c:'V',         m:'NYSE',   n:'Visa',              e:'Visa Inc'},
    {c:'WMT',       m:'NYSE',   n:'Walmart',           e:'Walmart Inc'},
    {c:'PLTR',      m:'NASDAQ', n:'Palantir',          e:'Palantir Technologies'},
    {c:'COIN',      m:'NASDAQ', n:'Coinbase',          e:'Coinbase Global'},
    {c:'UBER',      m:'NYSE',   n:'Uber',              e:'Uber Technologies'},
    {c:'ORCL',      m:'NYSE',   n:'Oracle',            e:'Oracle Corp'}
  ];

  var ALIAS = {
    'ì‚¼ì„±': '005930.KS', 'ì‚¼ì„±ì „ì': '005930.KS', 'samsung': '005930.KS',
    'í•˜ì´ë‹‰ìŠ¤': '000660.KS', 'skí•˜ì´ë‹‰ìŠ¤': '000660.KS',
    'ë„¤ì´ë²„': '035420.KS', 'naver': '035420.KS',
    'ì¹´ì¹´ì˜¤': '035720.KS', 'kakao': '035720.KS',
    'í˜„ëŒ€ì°¨': '005380.KS', 'í˜„ëŒ€ìë™ì°¨': '005380.KS',
    'ê¸°ì•„': '000270.KS', 'ê¸°ì•„ì°¨': '000270.KS',
    'ì…€íŠ¸ë¦¬ì˜¨': '068270.KS', 'ì¹´ì¹´ì˜¤ë±…í¬': '323410.KS',
    'í¬ë˜í”„í†¤': '259960.KS', 'í•˜ì´ë¸Œ': '352820.KS',
    'ì—”ì”¨': '036570.KS', 'ì—”ì”¨ì†Œí”„íŠ¸': '036570.KS', 'ë„·ë§ˆë¸”': '251270.KS',
    'kt': '030200.KS', 'skt': '017670.KS', 'skí…”ë ˆì½¤': '017670.KS',
    'lgì „ì': '066570.KS', 'lg': '003550.KS',
    'ì‹ í•œ': '055550.KS', 'kb': '105560.KS', 'kbê¸ˆìœµ': '105560.KS',
    'í•œì „': '015760.KS', 'í•œêµ­ì „ë ¥': '015760.KS',
    'ì´ê±´í™€ë”©ìŠ¤': '015360.KS', 'ì´ê±´': '015360.KS',
    'ì—ì½”í”„ë¡œë¹„ì— ': '247540.KQ', 'ì—ì½”í”„ë¡œ': '086520.KQ',
    'nvidia': 'NVDA', 'ì—”ë¹„ë””ì•„': 'NVDA',
    'tesla': 'TSLA', 'í…ŒìŠ¬ë¼': 'TSLA',
    'apple': 'AAPL', 'ì• í”Œ': 'AAPL',
    'microsoft': 'MSFT', 'ë§ˆì´í¬ë¡œì†Œí”„íŠ¸': 'MSFT',
    'google': 'GOOGL', 'êµ¬ê¸€': 'GOOGL',
    'amazon': 'AMZN', 'ì•„ë§ˆì¡´': 'AMZN',
    'meta': 'META', 'ë©”íƒ€': 'META',
    'netflix': 'NFLX', 'ë„·í”Œë¦­ìŠ¤': 'NFLX',
    'intel': 'INTC', 'ì¸í…”': 'INTC',
    'disney': 'DIS', 'ë””ì¦ˆë‹ˆ': 'DIS'
  };

  /* â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function gid(id) { return document.getElementById(id); }

  function isKR(sym) { return sym.slice(-3) === '.KS' || sym.slice(-3) === '.KQ'; }

  function fmtN(v, dec) {
    var n = parseFloat(String(v || 0).replace(/,/g, ''));
    if (!isFinite(n) || n === 0) return 'N/A';
    return n.toLocaleString('ko-KR', { maximumFractionDigits: dec || 2 });
  }

  function fmtP(v, kr) {
    var n = parseFloat(String(v || 0).replace(/,/g, ''));
    if (!isFinite(n) || n === 0) return 'N/A';
    return kr ? fmtN(n, 0) + 'ì›' : '$' + fmtN(n, n >= 100 ? 2 : 4);
  }

  function fmtPct(v) {
    var n = parseFloat(v || 0);
    return !isFinite(n) ? '' : (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
  }

  function fmtCap(v, kr) {
    if (!v || v <= 0) return 'N/A';
    if (kr) return v >= 1e12 ? fmtN(v / 1e12, 1) + 'ì¡°ì›' : fmtN(v / 1e8, 0) + 'ì–µì›';
    return '$' + fmtN(v / 1e9, 1) + 'B';
  }

  function resolve(raw) {
    var q = raw.trim();
    var lq = q.toLowerCase().replace(/\s+/g, '');
    var a = ALIAS[lq];
    if (a) return { sym: a, info: findDB(a) };
    var hit = null;
    for (var i = 0; i < DB.length; i++) {
      var d = DB[i];
      if (d.n.replace(/\s/g, '').toLowerCase() === lq ||
          d.e.replace(/\s/g, '').toLowerCase() === lq ||
          d.c.toLowerCase() === lq) {
        hit = d; break;
      }
    }
    if (hit) return { sym: hit.c, info: hit };
    if (/^\d{6}$/.test(q)) {
      var s = q + '.KS';
      return { sym: s, info: findDB(s) };
    }
    var u = q.toUpperCase();
    return { sym: u, info: findDB(u) };
  }

  function findDB(c) {
    for (var i = 0; i < DB.length; i++) {
      if (DB[i].c === c) return DB[i];
    }
    return null;
  }

  /* â”€â”€ Worker API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function apiStock(params) {
    var qs = Object.keys(params).map(function(k) {
      return encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
    }).join('&');
    return fetch('/api/stock?' + qs).then(function(res) {
      var ct = res.headers.get('content-type') || '';
      if (!ct.includes('json')) {
        showBanner();
        throw new Error('_worker.js ì—†ìŒ â€” GitHub ë£¨íŠ¸ì— _worker.js íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”');
      }
      return res.json();
    }).then(function(j) {
      if (!j.ok) throw new Error(j.error || 'ë°ì´í„° ì—†ìŒ');
      return j;
    });
  }

  function showBanner() {
    var b = gid('banner');
    b.className = 'err';
    b.innerHTML = '<h3>âš  _worker.js ë¯¸ì‘ë‹µ</h3>' +
      '<p>GitHub ë£¨íŠ¸ì— <code>_worker.js</code> íŒŒì¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br>' +
      'Cloudflare PagesëŠ” <code>_worker.js</code>ë¥¼ ìë™ìœ¼ë¡œ Workerë¡œ ì¸ì‹í•©ë‹ˆë‹¤.<br>' +
      '<a href="/api/health" target="_blank" style="color:var(--acc)">â†’ /api/health í™•ì¸í•˜ê¸°</a></p>';
    b.style.display = 'block';
  }

  /* â”€â”€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var chartInst = null;

  function drawChart(hist, kr) {
    var labels = hist.map(function(h) {
      var p = h.date.split('-');
      return p.length === 3 ? (parseInt(p[1], 10) + '/' + parseInt(p[2], 10)) : h.date;
    });
    var prices = hist.map(function(h) { return h.close; }).filter(function(v) { return v > 0; });
    if (!prices.length) return;
    var ctx = gid('mychart').getContext('2d');
    if (chartInst) chartInst.destroy();
    var up = prices[prices.length - 1] >= prices[0];
    var col = up ? '#3fb950' : '#f85149';
    chartInst = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          data: prices,
          borderColor: col,
          borderWidth: 2.5,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: col,
          fill: true,
          tension: 0.36,
          backgroundColor: function(c) {
            var g = c.chart.ctx.createLinearGradient(0, 0, 0, 240);
            g.addColorStop(0, up ? 'rgba(63,185,80,.25)' : 'rgba(248,81,73,.25)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            return g;
          }
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#0d1117',
            borderColor: '#21262d',
            borderWidth: 1,
            titleColor: '#8b949e',
            bodyColor: '#e6edf3',
            bodyFont: { family: 'JetBrains Mono', size: 11 },
            padding: 10,
            callbacks: {
              label: function(c) {
                return ' ' + (kr ? fmtN(c.parsed.y, 0) + 'ì›' : '$' + fmtN(c.parsed.y, 2));
              }
            }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(33,38,45,.7)' },
            ticks: { color: '#484f58', maxTicksLimit: 8, font: { family: 'JetBrains Mono', size: 11 } }
          },
          y: {
            grid: { color: 'rgba(33,38,45,.7)' },
            ticks: {
              color: '#484f58',
              font: { family: 'JetBrains Mono', size: 11 },
              callback: function(v) { return kr ? fmtN(v, 0) : '$' + fmtN(v, 0); }
            }
          }
        }
      }
    });
  }

  /* â”€â”€ AI ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildPrompt(sd) {
    var vals = sd.prices.filter(function(v) { return v > 0; });
    var mx = vals.length ? Math.max.apply(null, vals) : 0;
    var mn = vals.length ? Math.min.apply(null, vals) : 0;
    var vol = mn > 0 ? (((mx - mn) / mn) * 100).toFixed(1) : 0;
    var trend = vals.length >= 2 ? (vals[vals.length - 1] > vals[0] ? 'ìƒìŠ¹' : 'í•˜ë½') : 'ë³´í•©';
    var rec = vals.slice(-10).map(function(v, i) { return 'D' + (i + 1) + ':' + Number(v).toFixed(2); }).join(', ');
    return 'ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì£¼ì‹ ì• ë„ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n\n' +
      'ì¢…ëª©: ' + sd.name + ' (' + sd.sym + ') | ì‹œì¥: ' + sd.mkt + ' | í˜„ì¬ê°€: ' + sd.priceRaw + ' | ë“±ë½: ' + sd.chgPct + '%\n' +
      '52ì£¼ê³ ê°€: ' + sd.h52 + ' | 52ì£¼ì €ê°€: ' + sd.l52 + ' | ê±°ë˜ëŸ‰: ' + sd.vol + ' | ì‹œê°€ì´ì•¡: ' + sd.mktcap + ' | PER: ' + sd.per + '\n' +
      'ìµœê·¼10ì¼: ' + rec + ' | íŠ¸ë Œë“œ: ' + trend + ' | ë³€ë™ì„±: ' + vol + '%\n\n' +
      'JSON:\n' +
      '{"verdict":"ë§¤ìˆ˜|ë§¤ë„|ê´€ë§|ì£¼ëª©","verdictReason":"3~4ë¬¸ì¥","buyStrategy":{"zone":"êµ¬ê°„","timing":"íƒ€ì´ë°","split":["1ì°¨","2ì°¨"]},"sellStrategy":{"shortTarget":"ë‹¨ê¸°","midTarget":"ì¤‘ê¸°","stopLoss":"ì†ì ˆ","exitSignal":"ìµì ˆì‹ í˜¸"},"risks":["ë¦¬1","ë¦¬2","ë¦¬3"],"riskLevel":"ë‚®ìŒ|ì¤‘ê°„|ë†’ìŒ","riskScore":40,"scenarios":{"bull":{"price":"ë‚™ê´€","desc":"ì„¤ëª…"},"base":{"price":"ì¤‘ë¦½","desc":"ì„¤ëª…"},"bear":{"price":"ë¹„ê´€","desc":"ì„¤ëª…"}},"watchPoints":["í¬1","í¬2","í¬3"],"summary":"2ë¬¸ì¥"}';
  }

  function callAI(sd) {
    return fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: buildPrompt(sd) })
    }).then(function(r) {
      var ct = r.headers.get('content-type') || '';
      if (!ct.includes('json')) throw new Error('AI Worker ë¯¸ì‘ë‹µ');
      return r.json();
    });
  }

  function renderAI(r) {
    var vcMap = { 'ë§¤ìˆ˜': 'buy', 'ë§¤ë„': 'sell', 'ê´€ë§': 'hold', 'ì£¼ëª©': 'watch' };
    var vc = vcMap[r.verdict] || 'hold';
    var sc = Math.min(100, Math.max(0, r.riskScore || 50));
    var rc = sc < 35 ? 'low' : sc < 65 ? 'mid' : 'high';
    var bs = r.buyStrategy || {};
    var ss = r.sellStrategy || {};
    var scen = r.scenarios || {};
    var splitHtml = (bs.split && bs.split.length) ? '<p class="ai-sub-text">ë¶„í• ë§¤ìˆ˜: ' + bs.split.join(' â†’ ') + '</p>' : '';
    var timingHtml = bs.timing ? '<p class="ai-sub-text">íƒ€ì´ë°: ' + bs.timing + '</p>' : '';
    var exitHtml = ss.exitSignal ? '<p class="ai-sub-text">ìµì ˆ ì‹ í˜¸: ' + ss.exitSignal + '</p>' : '';
    var risksHtml = (r.risks || []).map(function(x) { return '<li><span style="color:#e6edf3">' + x + '</span></li>'; }).join('');
    var watchHtml = (r.watchPoints || []).map(function(x) { return '<li><span style="color:#e6edf3">' + x + '</span></li>'; }).join('');
    var bullScen = scen.bull || {};
    var baseScen = scen.base || {};
    var bearScen = scen.bear || {};

    gid('aiContent').innerHTML =
      '<div class="ai-sec">' +
        '<div class="ai-sec-title">ì¢…í•© íˆ¬ì ì˜ê²¬</div>' +
        '<div class="verdict-row">' +
          '<span class="verdict-chip vc-' + vc + '">' + (r.verdict || 'ê´€ë§') + '</span>' +
          '<span class="verdict-chip vc-' + rc + '">ë¦¬ìŠ¤í¬ ' + (r.riskLevel || 'ì¤‘ê°„') + '</span>' +
        '</div>' +
        '<p class="ai-text">' + (r.verdictReason || r.summary || '') + '</p>' +
      '</div>' +
      '<div class="ai-sec">' +
        '<div class="ai-sec-title">ë§¤ìˆ˜ / ë§¤ë„ ì „ëµ</div>' +
        '<div class="strat-row">' +
          '<div class="strat-box buy"><div class="strat-label">ë§¤ìˆ˜ êµ¬ê°„</div><div class="strat-val" style="font-size:.8rem">' + (bs.zone || 'N/A') + '</div></div>' +
          '<div class="strat-box sell"><div class="strat-label">ë‹¨ê¸° ëª©í‘œê°€</div><div class="strat-val">' + (ss.shortTarget || 'N/A') + '</div></div>' +
          '<div class="strat-box mid"><div class="strat-label">ì¤‘ê¸° ëª©í‘œê°€</div><div class="strat-val">' + (ss.midTarget || 'N/A') + '</div></div>' +
          '<div class="strat-box stop"><div class="strat-label">ì†ì ˆê°€</div><div class="strat-val">' + (ss.stopLoss || 'N/A') + '</div></div>' +
        '</div>' +
        splitHtml + timingHtml + exitHtml +
      '</div>' +
      '<div class="ai-sec">' +
        '<div class="ai-sec-title">3ê°œì›” ì‹œë‚˜ë¦¬ì˜¤</div>' +
        '<div class="strat-row">' +
          '<div class="strat-box buy"><div class="strat-label">ğŸŸ¢ ë‚™ê´€</div><div class="strat-val">' + (bullScen.price || 'N/A') + '</div><p style="font-size:.75rem;color:#8b949e;margin-top:5px;line-height:1.6">' + (bullScen.desc || '') + '</p></div>' +
          '<div class="strat-box mid"><div class="strat-label">ğŸ”µ ì¤‘ë¦½</div><div class="strat-val">' + (baseScen.price || 'N/A') + '</div><p style="font-size:.75rem;color:#8b949e;margin-top:5px;line-height:1.6">' + (baseScen.desc || '') + '</p></div>' +
          '<div class="strat-box sell"><div class="strat-label">ğŸ”´ ë¹„ê´€</div><div class="strat-val">' + (bearScen.price || 'N/A') + '</div><p style="font-size:.75rem;color:#8b949e;margin-top:5px;line-height:1.6">' + (bearScen.desc || '') + '</p></div>' +
        '</div>' +
      '</div>' +
      '<div class="ai-sec">' +
        '<div class="ai-sec-title">ë¦¬ìŠ¤í¬ ë¶„ì„</div>' +
        '<div class="risk-bar-row">' +
          '<span class="risk-label">ë¦¬ìŠ¤í¬</span>' +
          '<div class="risk-track"><div class="risk-fill ' + rc + '" id="riskBar" style="width:0%"></div></div>' +
          '<span class="risk-pct">' + sc + '%</span>' +
        '</div>' +
        '<ul style="padding-left:19px;margin-top:12px;color:#8b949e;font-size:.87rem;line-height:2.2">' + risksHtml + '</ul>' +
      '</div>' +
      '<div class="ai-sec">' +
        '<div class="ai-sec-title">í•µì‹¬ ê´€ì „ í¬ì¸íŠ¸</div>' +
        '<ol style="padding-left:21px;font-size:.87rem;line-height:2.4">' + watchHtml + '</ol>' +
      '</div>';

    gid('aiContent').style.display = 'block';
    gid('aiLoad').style.display = 'none';
    setTimeout(function() {
      var bar = gid('riskBar');
      if (bar) bar.style.width = sc + '%';
    }, 100);
  }

  /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function toast(msg) {
    var old = document.querySelectorAll('.toast');
    for (var i = 0; i < old.length; i++) old[i].remove();
    var el = document.createElement('div');
    el.className = 'toast';
    el.textContent = 'âš  ' + msg;
    document.body.appendChild(el);
    setTimeout(function() { if (el.parentNode) el.remove(); }, 7000);
  }

  /* â”€â”€ ë©”ì¸ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function doSearch(raw) {
    var q = raw.trim();
    if (!q) return;
    gid('rs').style.display = 'none';
    gid('btn').disabled = true;
    gid('btn').textContent = 'ë¡œë”© ì¤‘...';

    var resolved = resolve(q);
    var sym = resolved.sym;
    var info = resolved.info;
    var kr = isKR(sym);
    var mkt = info ? info.m : (kr ? 'KOSPI' : 'US MARKET');
    gid('btn').textContent = 'ë°ì´í„° ìˆ˜ì§‘ ì¤‘...';

    Promise.all([
      apiStock({ action: 'quote', symbol: sym }),
      apiStock({ action: 'chart', symbol: sym, days: 30 })
    ]).then(function(results) {
      var qData = results[0];
      var hData = results[1];
      var hist = hData.history || [];
      var prices = hist.map(function(h) { return h.close; }).filter(function(v) { return v > 0; });
      var p = qData.price || 0;
      var chg = qData.change || 0;
      var pct = qData.changePct || 0;
      var up = chg >= 0;
      var ps = fmtP(p, kr);
      var chgStr = (up ? '+' : '') +
        (kr ? fmtN(chg, 0) + 'ì›' : (chg >= 0 ? '+$' : '-$') + fmtN(Math.abs(chg), 2)) +
        ' (' + fmtPct(pct) + ')';

      var sd = {
        sym: sym, mkt: mkt,
        name: qData.name || (info ? info.n : sym),
        priceRaw: p, chgPct: pct,
        h52: fmtP(qData.high52, kr),
        l52: fmtP(qData.low52, kr),
        vol: fmtN(qData.volume, 0),
        mktcap: fmtCap(qData.marketCap, kr),
        per: fmtN(qData.per, 1),
        prices: prices
      };

      gid('rMkt').textContent = mkt;
      gid('rTime').textContent = 'ì‹¤ì‹œê°„ Â· ' + new Date().toLocaleTimeString('ko-KR');
      gid('rName').textContent = sd.name;
      gid('rTicker').textContent = sym;
      gid('rPrice').textContent = ps;
      gid('rChange').textContent = chgStr;
      gid('rChange').className = 'price-chg ' + (up ? 'up' : 'dn');

      var statsData = [
        { l: '52ì£¼ ê³ ê°€', v: sd.h52 },
        { l: '52ì£¼ ì €ê°€', v: sd.l52 },
        { l: 'ê±°ë˜ëŸ‰',   v: sd.vol },
        { l: 'ì‹œê°€ì´ì•¡', v: sd.mktcap },
        { l: 'PER',      v: sd.per },
        { l: 'ë“±ë½ë¥ ',   v: fmtPct(pct) }
      ];
      gid('statsGrid').innerHTML = statsData.map(function(x) {
        return '<div class="stat-item"><div class="stat-label">' + x.l + '</div><div class="stat-val">' + x.v + '</div></div>';
      }).join('');

      if (hist.length) drawChart(hist, kr);
      gid('rs').style.display = 'block';
      gid('rs').scrollIntoView({ behavior: 'smooth', block: 'start' });

      gid('aiLoad').style.display = 'flex';
      gid('aiContent').style.display = 'none';
      gid('btn').textContent = 'AI ë¶„ì„ ì¤‘...';

      callAI(sd).then(function(r) {
        if (r.verdict) {
          renderAI(r);
        } else {
          gid('aiLoad').style.display = 'none';
          gid('aiContent').innerHTML = '<p style="color:#8b949e">AI ì‘ë‹µ ì—†ìŒ. Cloudflare Pages â†’ Settings â†’ Environment variables ì— <code style="color:#00d4aa">ANTHROPIC_API_KEY</code> ì¶”ê°€ í•„ìš”.</p>';
          gid('aiContent').style.display = 'block';
        }
      }).catch(function(e) {
        gid('aiLoad').style.display = 'none';
        gid('aiContent').innerHTML = '<p style="color:#f85149;font-weight:700;margin-bottom:8px">âš  AI ì—°ê²° ì˜¤ë¥˜</p><p style="color:#8b949e;font-size:.85rem">' + e.message + '</p>';
        gid('aiContent').style.display = 'block';
      });

    }).catch(function(e) {
      console.error(e);
      toast(e.message);
    }).finally(function() {
      gid('btn').disabled = false;
      gid('btn').textContent = 'ë¶„ì„í•˜ê¸°';
    });
  }

  /* â”€â”€ ìë™ì™„ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var sugTimer = null;

  function showSug(query) {
    var q = query.trim().toLowerCase().replace(/\s+/g, '');
    if (!q) { hideSug(); return; }
    var hits = [];
    var seen = {};
    for (var i = 0; i < DB.length && hits.length < 8; i++) {
      var d = DB[i];
      if (seen[d.c]) continue;
      if (d.n.replace(/\s/g, '').toLowerCase().indexOf(q) >= 0 ||
          d.e.replace(/\s/g, '').toLowerCase().indexOf(q) >= 0 ||
          d.c.toLowerCase().indexOf(q) >= 0) {
        hits.push(d);
        seen[d.c] = true;
      }
    }
    if (!hits.length) { hideSug(); return; }
    var mc = { KOSPI: 'k', KOSDAQ: 'q', NASDAQ: 'u', NYSE: 'u' };
    gid('sug').innerHTML = hits.map(function(d) {
      return '<div class="sg" data-c="' + d.c + '">' +
        '<div><div class="sg-name">' + d.n + ' <span style="color:#484f58;font-size:.74rem">' + d.e + '</span></div>' +
        '<div class="sg-sub">' + d.c + ' Â· ' + d.m + '</div></div>' +
        '<span class="sg-badge ' + (mc[d.m] || 'u') + '">' + d.m + '</span>' +
        '</div>';
    }).join('');
    gid('sug').classList.add('open');
    var items = gid('sug').querySelectorAll('.sg');
    for (var j = 0; j < items.length; j++) {
      (function(el) {
        el.addEventListener('click', function() {
          var found = findDB(el.getAttribute('data-c'));
          gid('q').value = found ? found.n : el.getAttribute('data-c');
          hideSug();
          doSearch(el.getAttribute('data-c'));
        });
      })(items[j]);
    }
  }

  function hideSug() { gid('sug').classList.remove('open'); }

  /* â”€â”€ ì¸ê¸° ì¢…ëª© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var POP = [
    { c: '005930.KS', n: 'ì‚¼ì„±ì „ì',   m: 'KOSPI'  },
    { c: '000660.KS', n: 'SKí•˜ì´ë‹‰ìŠ¤', m: 'KOSPI'  },
    { c: '035420.KS', n: 'NAVER',      m: 'KOSPI'  },
    { c: 'NVDA',      n: 'NVIDIA',     m: 'NASDAQ' },
    { c: 'AAPL',      n: 'Apple',      m: 'NASDAQ' },
    { c: 'TSLA',      n: 'Tesla',      m: 'NASDAQ' }
  ];

  function loadPop() {
    var pg = gid('popGrid');
    pg.innerHTML = POP.map(function() { return '<div class="skel"></div>'; }).join('');
    var promises = POP.map(function(p) {
      return apiStock({ action: 'quote', symbol: p.c }).then(function(q) {
        return { ok: true, p: p, q: q };
      }).catch(function() {
        return { ok: false, p: p };
      });
    });
    Promise.all(promises).then(function(results) {
      pg.innerHTML = results.map(function(r) {
        var p = r.p;
        var kr = isKR(p.c);
        if (!r.ok) {
          return '<div class="pop-card" data-c="' + p.c + '">' +
            '<div class="pop-sym">' + p.c + ' Â· ' + p.m + '</div>' +
            '<div class="pop-name">' + p.n + '</div>' +
            '<div class="pop-price" style="color:#484f58">â€”</div>' +
            '<div class="pop-chg na">ë°ì´í„° ì—†ìŒ</div>' +
            '</div>';
        }
        var q = r.q;
        var up = (q.changePct || 0) >= 0;
        return '<div class="pop-card" data-c="' + p.c + '">' +
          '<div class="pop-sym">' + p.c + ' Â· ' + p.m + '</div>' +
          '<div class="pop-name">' + (q.name || p.n) + '</div>' +
          '<div class="pop-price">' + fmtP(q.price, kr) + '</div>' +
          '<div class="pop-chg ' + (up ? 'up' : 'dn') + '">' + fmtPct(q.changePct) + '</div>' +
          '</div>';
      }).join('');
      var cards = pg.querySelectorAll('.pop-card');
      for (var i = 0; i < cards.length; i++) {
        (function(el) {
          el.addEventListener('click', function() { doSearch(el.getAttribute('data-c')); });
        })(cards[i]);
      }
    });
  }

  /* â”€â”€ í‹°ì»¤ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function loadTicker() {
    var T = [
      { c: '005930.KS', n: 'ì‚¼ì„±ì „ì'   },
      { c: '000660.KS', n: 'SKí•˜ì´ë‹‰ìŠ¤' },
      { c: '035420.KS', n: 'NAVER'      },
      { c: 'NVDA',      n: 'NVIDIA'     },
      { c: 'AAPL',      n: 'Apple'      },
      { c: 'TSLA',      n: 'Tesla'      },
      { c: 'MSFT',      n: 'Microsoft'  },
      { c: '035720.KS', n: 'ì¹´ì¹´ì˜¤'     }
    ];
    var promises = T.map(function(t) {
      return apiStock({ action: 'quote', symbol: t.c }).then(function(q) {
        return { ok: true, t: t, price: q.price, pct: q.changePct, kr: isKR(t.c) };
      }).catch(function() { return null; });
    });
    Promise.all(promises).then(function(results) {
      var items = results.filter(function(r) { return r && r.ok; });
      if (!items.length) {
        gid('tbTrack').innerHTML = '<span class="ti-ph">_worker.js ë°°í¬ í›„ ì´ìš© ê°€ëŠ¥</span>';
        return;
      }
      function makeHtml() {
        return items.map(function(item) {
          var up = (item.pct || 0) >= 0;
          var ps = item.kr ? fmtN(item.price, 0) + 'ì›' : '$' + fmtN(item.price, 2);
          return '<span class="ti" data-c="' + item.t.c + '">' +
            '<b>' + item.t.n + '</b>' + ps +
            '<span class="' + (up ? 'up' : 'dn') + '">' + fmtPct(item.pct) + '</span>' +
            '</span>';
        }).join('');
      }
      var track = gid('tbTrack');
      track.innerHTML = makeHtml() + makeHtml();
      var tis = track.querySelectorAll('.ti');
      for (var i = 0; i < tis.length; i++) {
        (function(el) {
          el.addEventListener('click', function() { doSearch(el.getAttribute('data-c')); });
        })(tis[i]);
      }
    });
  }

  /* â”€â”€ ì´ë²¤íŠ¸ ë°”ì¸ë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  gid('btn').addEventListener('click', function() { doSearch(gid('q').value); });

  gid('q').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { hideSug(); doSearch(gid('q').value); }
    if (e.key === 'Escape') hideSug();
  });

  gid('q').addEventListener('input', function(e) {
    clearTimeout(sugTimer);
    sugTimer = setTimeout(function() { showSug(e.target.value); }, 130);
  });

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.sw')) hideSug();
  });

  var chips = document.querySelectorAll('.chip');
  for (var ci = 0; ci < chips.length; ci++) {
    (function(chip) {
      chip.addEventListener('click', function() {
        for (var i = 0; i < chips.length; i++) chips[i].classList.remove('on');
        chip.classList.add('on');
      });
    })(chips[ci]);
  }

  /* â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  fetch('/api/health').then(function(r) {
    var ct = r.headers.get('content-type') || '';
    if (!ct.includes('json')) showBanner();
  }).catch(function() { showBanner(); });

  loadTicker();
  loadPop();

})();
</script>
</body>
</html>
