<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>ğŸ“ˆ KRX AI ë§¤ë§¤ ì „ëµ ë¶„ì„ê¸°</title>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#0e1117;
    color:white;
}

.wrapper{
    max-width:1200px;
    margin:auto;
    padding:40px 20px;
}

h1{
    font-size:30px;
    margin-bottom:25px;
}

.controls{
    display:flex;
    gap:10px;
    margin-bottom:25px;
}

input, select{
    flex:1;
    padding:12px;
    border-radius:8px;
    border:none;
    font-size:15px;
}

button{
    padding:12px 18px;
    background:#16c784;
    border:none;
    color:white;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
}

.metrics{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:12px;
    margin-bottom:25px;
}

.card{
    background:#1b222c;
    border-radius:14px;
    padding:18px;
    text-align:center;
}

.card h3{
    font-size:13px;
    opacity:.7;
    margin:0;
}

.card p{
    font-size:22px;
    font-weight:bold;
    margin:10px 0 0;
}

#chart{
    height:650px;
    margin-top:20px;
}

#analysis{
    background:#1b222c;
    padding:20px;
    border-radius:12px;
    margin-top:25px;
    line-height:1.6;
}
</style>
</head>

<body>

<div class="wrapper">

<h1>ğŸ“ˆ KRX AI ë§¤ë§¤ ì „ëµ ë¶„ì„ê¸°</h1>

<div class="controls">
    <input id="search" placeholder="ì¢…ëª© ê²€ìƒ‰ (ì‚¼ì„±, sk, apple ë“±)" />
    <select id="stock"></select>
    <button onclick="run()">ë¶„ì„ ì‹œì‘</button>
</div>

<div class="metrics">
    <div class="card"><h3>í˜„ì¬ê°€</h3><p id="cur">-</p></div>
    <div class="card"><h3>ë§¤ìˆ˜ ì¶”ì²œê°€</h3><p id="buy">-</p></div>
    <div class="card"><h3>ì†ì ˆ</h3><p id="stop">-</p></div>
    <div class="card"><h3>ëª©í‘œ</h3><p id="target">-</p></div>
</div>

<div id="chart"></div>

<div id="analysis"></div>

</div>

<script>

////////////////////////////////////////////////////////
// ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (CSV ëŒ€ì‹  ê°„ë‹¨ ë‚´ì¥, í•„ìš”í•˜ë©´ í™•ì¥ ê°€ëŠ¥)
////////////////////////////////////////////////////////

const stocks = [
    {name:"ì‚¼ì„±ì „ì", ticker:"005930.KS"},
    {name:"SKí•˜ì´ë‹‰ìŠ¤", ticker:"000660.KS"},
    {name:"ë„¤ì´ë²„", ticker:"035420.KS"},
    {name:"ì¹´ì¹´ì˜¤", ticker:"035720.KS"},
    {name:"Apple", ticker:"AAPL"},
    {name:"Tesla", ticker:"TSLA"},
];

const select = document.getElementById("stock");

function populate(list){
    select.innerHTML="";
    list.forEach(s=>{
        const op=document.createElement("option");
        op.value=s.ticker;
        op.textContent=`${s.name} (${s.ticker})`;
        select.appendChild(op);
    });
}

populate(stocks);

////////////////////////////////////////////////////////
// ê²€ìƒ‰ í•„í„°
////////////////////////////////////////////////////////

document.getElementById("search").addEventListener("input", e=>{
    const q=e.target.value.toLowerCase();
    const filtered=stocks.filter(s=>s.name.toLowerCase().includes(q));
    populate(filtered);
});

////////////////////////////////////////////////////////
// ê³„ì‚° ìœ í‹¸
////////////////////////////////////////////////////////

const mean = arr => arr.reduce((a,b)=>a+b,0)/arr.length;

const std = arr => {
    const m=mean(arr);
    return Math.sqrt(mean(arr.map(x=>(x-m)**2)));
};

////////////////////////////////////////////////////////
// ë©”ì¸ ì‹¤í–‰ (Streamlit ë¡œì§ ê·¸ëŒ€ë¡œ ë³µì œ)
////////////////////////////////////////////////////////

async function run(){

    const ticker = select.value;

    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=2y&interval=1d`;

    const res = await fetch(url);
    const data = await res.json();

    const close = data.chart.result[0].indicators.quote[0].close.filter(x=>x);

    const current = close.at(-1);

    const ma20 = mean(close.slice(-20));
    const ma60 = mean(close.slice(-60));

    const returns = close.slice(1).map((p,i)=>(p-close[i])/close[i]);
    const vol = std(returns);

    const buy = ma20*0.98;
    const stop = buy*(1-vol*3);
    const target = buy*1.20;

    document.getElementById("cur").innerText=current.toFixed(0);
    document.getElementById("buy").innerText=buy.toFixed(0);
    document.getElementById("stop").innerText=stop.toFixed(0);
    document.getElementById("target").innerText=target.toFixed(0);

    Plotly.newPlot("chart",[
        {y:close,name:"Price"},
        {y:close.map((_,i)=>i<20?null:mean(close.slice(i-20,i))),name:"MA20"},
        {y:close.map((_,i)=>i<60?null:mean(close.slice(i-60,i))),name:"MA60"},
    ],{
        height:650,
        hovermode:"x unified"
    });

    document.getElementById("analysis").innerHTML=`
    <h3>ğŸ¤– AI ì „ëµ ë¶„ì„</h3>
    ğŸ“‰ ë§¤ìˆ˜ ì¶”ì²œê°€: ${buy.toFixed(0)}ì›<br>
    ğŸ›‘ ì†ì ˆê°€: ${stop.toFixed(0)}ì›<br>
    ğŸ¯ ëª©í‘œê°€: ${target.toFixed(0)}ì›<br>
    ë³€ë™ì„±: ${(vol*100).toFixed(2)}%<br><br>
    ğŸ‘‰ ë‹¨ê¸° ëˆŒë¦¼ëª© ë§¤ìˆ˜ ì „ëµ<br>
    ğŸ‘‰ ìŠ¤ìœ™ íŠ¸ë ˆì´ë”© ì í•©
    `;
}

////////////////////////////////////////////////////////
// ì—”í„° ì‹¤í–‰
////////////////////////////////////////////////////////

document.addEventListener("keydown",e=>{
    if(e.key==="Enter") run();
});
</script>

</body>
</html>
