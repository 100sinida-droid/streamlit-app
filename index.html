<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StockMind AI â€” ì‹¤ì‹œê°„ ì£¼ì‹ ë¶„ì„</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#07090d;--bg2:#0d1117;--bg3:#161b22;
  --brd:#21262d;--acc:#00d4aa;--ac2:#ff6b35;--ac3:#7c3aed;
  --tx:#e6edf3;--tx2:#8b949e;--tx3:#484f58;
  --up:#3fb950;--dn:#f85149;--r:12px;
  --fd:'Bebas Neue',sans-serif;
  --fb:'Noto Sans KR',sans-serif;
  --fm:'JetBrains Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--tx);font-family:var(--fb);min-height:100vh;overflow-x:hidden;line-height:1.6}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.35;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E")}

/* â”€â”€ HEADER â”€â”€ */
header{position:sticky;top:0;z-index:100;background:rgba(7,9,13,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 28px;height:56px;gap:20px}
.logo{font-family:var(--fd);font-size:1.55rem;letter-spacing:2px;color:var(--tx);flex-shrink:0;white-space:nowrap}.logo span{color:var(--acc)}
.tb{flex:1;overflow:hidden;position:relative}
.tb::before,.tb::after{content:'';position:absolute;top:0;bottom:0;width:48px;z-index:2;pointer-events:none}
.tb::before{left:0;background:linear-gradient(to right,var(--bg),transparent)}
.tb::after{right:0;background:linear-gradient(to left,var(--bg),transparent)}
.tb-track{display:flex;gap:32px;white-space:nowrap;animation:ticker 40s linear infinite}
.tb-track:hover{animation-play-state:paused}
@keyframes ticker{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.ti{font-family:var(--fm);font-size:.76rem;color:var(--tx2);display:inline-flex;align-items:center;gap:7px;cursor:pointer;transition:color .2s;flex-shrink:0}
.ti:hover{color:var(--tx)}.ti b{color:var(--tx);font-weight:700}
.tu{color:var(--up)}.td{color:var(--dn)}
.ti-ph{color:var(--tx3);font-family:var(--fm);font-size:.76rem}

/* â”€â”€ MAIN â”€â”€ */
main{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:0 24px 80px}

/* â”€â”€ HERO â”€â”€ */
.hero{padding:74px 0 52px;text-align:center}
.hero-badge{display:inline-block;margin-bottom:24px;font-family:var(--fm);font-size:.72rem;letter-spacing:3px;text-transform:uppercase;color:var(--acc);border:1px solid rgba(0,212,170,.28);padding:4px 16px;border-radius:100px}
.hero h1{font-family:var(--fd);font-size:clamp(2.8rem,8vw,5.3rem);line-height:1.06;letter-spacing:1px;color:var(--tx);margin-bottom:16px}
.hero h1 em{font-style:normal;color:var(--acc);position:relative}
.hero h1 em::after{content:'';position:absolute;bottom:2px;left:0;right:0;height:3px;background:linear-gradient(to right,var(--acc),transparent);border-radius:2px}
.hero-sub{color:var(--tx2);font-size:.97rem;line-height:1.9;margin-bottom:40px}

/* â”€â”€ SEARCH â”€â”€ */
.sw{position:relative;max-width:700px;margin:0 auto 22px}
.sb{display:flex;align-items:center;background:var(--bg3);border:1.5px solid var(--brd);border-radius:14px;padding:6px 6px 6px 20px;gap:10px;transition:border-color .25s,box-shadow .25s}
.sb:focus-within{border-color:var(--acc);box-shadow:0 0 0 3px rgba(0,212,170,.1),0 8px 28px rgba(0,0,0,.4)}
.si{width:20px;height:20px;color:var(--tx3);flex-shrink:0}
#q{flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:var(--fb);font-size:1rem;padding:10px 0}
#q::placeholder{color:var(--tx3)}
#btn{background:var(--acc);color:var(--bg);border:none;border-radius:10px;padding:12px 26px;font-family:var(--fb);font-weight:700;font-size:.9rem;cursor:pointer;white-space:nowrap;transition:background .2s,transform .15s}
#btn:hover{background:#00c09a;transform:translateY(-1px)}#btn:active{transform:none}#btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* AUTOCOMPLETE */
#sug{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--bg3);border:1px solid var(--brd);border-radius:12px;overflow:hidden;z-index:60;display:none;box-shadow:0 16px 48px rgba(0,0,0,.6)}
#sug.open{display:block}
.sg{display:flex;justify-content:space-between;align-items:center;padding:11px 18px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--brd)}
.sg:last-child{border-bottom:none}.sg:hover{background:rgba(255,255,255,.04)}
.sg-n{font-size:.92rem;font-weight:500}.sg-s{font-family:var(--fm);font-size:.7rem;color:var(--tx2);margin-top:2px}
.sg-m{font-size:.67rem;padding:3px 9px;border-radius:100px;font-weight:700;flex-shrink:0}
.sg-m.k{background:rgba(124,58,237,.18);color:#a78bfa}.sg-m.q{background:rgba(0,212,170,.14);color:var(--acc)}.sg-m.u{background:rgba(255,107,53,.14);color:var(--ac2)}

/* CHIPS */
.chips{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.chip{background:var(--bg3);border:1px solid var(--brd);color:var(--tx2);border-radius:100px;padding:6px 18px;font-family:var(--fm);font-size:.78rem;cursor:pointer;transition:all .2s}
.chip:hover,.chip.on{background:var(--acc);color:var(--bg);border-color:var(--acc)}

/* â”€â”€ STATUS BANNER â”€â”€ */
#banner{display:none;margin-top:20px;border-radius:var(--r);padding:22px 26px}
#banner.err{background:rgba(248,81,73,.07);border:1px solid rgba(248,81,73,.28)}
#banner.ok{background:rgba(63,185,80,.07);border:1px solid rgba(63,185,80,.28)}
#banner h3{font-size:.95rem;margin-bottom:10px}
#banner.err h3{color:var(--dn)}#banner.ok h3{color:var(--up)}
#banner p{color:var(--tx2);font-size:.86rem;line-height:1.9}
#banner code{color:var(--acc);font-family:var(--fm);background:rgba(0,212,170,.08);padding:2px 6px;border-radius:4px}

/* â”€â”€ RESULT â”€â”€ */
.rs{margin-top:16px;animation:fu .4s ease both}
@keyframes fu{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}
.rh{background:var(--bg2);border:1px solid var(--brd);border-radius:var(--r);padding:26px 30px;margin-bottom:16px;position:relative;overflow:hidden}
.rh::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(to right,var(--acc),var(--ac3))}
.rm{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.rm-mkt{font-family:var(--fm);font-size:.7rem;padding:3px 10px;border-radius:100px;background:rgba(0,212,170,.13);color:var(--acc);font-weight:700}
.rm-time{font-family:var(--fm);font-size:.7rem;color:var(--tx3)}
.rn{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.rn h2{font-family:var(--fd);font-size:2rem;letter-spacing:1px}
.rbadge{font-family:var(--fm);font-size:.82rem;color:var(--tx2);background:var(--bg3);border:1px solid var(--brd);padding:3px 12px;border-radius:8px}
.pb{display:flex;align-items:baseline;gap:14px;flex-wrap:wrap}
.pm{font-family:var(--fm);font-size:2.5rem;font-weight:700}
.pc{font-family:var(--fm);font-size:1.05rem;font-weight:700}
.pc.up{color:var(--up)}.pc.dn{color:var(--dn)}

/* DATA GRID */
.dg{display:grid;grid-template-columns:1fr 310px;gap:16px;margin-bottom:16px}
@media(max-width:760px){.dg{grid-template-columns:1fr}}
.cc,.sc{background:var(--bg2);border:1px solid var(--brd);border-radius:var(--r);padding:22px}
.cl{font-family:var(--fm);font-size:.7rem;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:16px}
#mychart{width:100%!important;height:220px!important}
.sg2{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.si2{background:var(--bg3);border-radius:8px;padding:12px}
.sl2{font-family:var(--fm);font-size:.6rem;letter-spacing:1px;text-transform:uppercase;color:var(--tx3);margin-bottom:5px}
.sv{font-family:var(--fm);font-size:.9rem;font-weight:700;color:var(--tx)}

/* AI PANEL */
.ap{background:var(--bg2);border:1px solid var(--brd);border-radius:var(--r);padding:26px 30px;position:relative;overflow:hidden}
.ap::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at top left,rgba(124,58,237,.05),transparent 55%)}
.ah{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.ab{display:flex;align-items:center;gap:8px;font-weight:700;color:var(--acc)}
.at2{font-family:var(--fm);font-size:.67rem;color:var(--tx3);padding:3px 10px;border:1px solid var(--brd);border-radius:100px}
.al{display:flex;align-items:center;gap:13px;padding:26px 0;color:var(--tx2);font-size:.87rem}
.sp{width:32px;height:32px;flex-shrink:0;border:3px solid transparent;border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* AI CONTENT */
.as{margin-bottom:24px}.as:last-child{margin-bottom:0}
.ast{font-family:var(--fm);font-size:.7rem;letter-spacing:2px;text-transform:uppercase;color:var(--acc);margin-bottom:11px;padding-bottom:7px;border-bottom:1px solid rgba(0,212,170,.17)}
.vc{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.vch{padding:7px 18px;border-radius:100px;font-weight:700;font-size:.85rem;font-family:var(--fm)}
.vch.buy{background:rgba(63,185,80,.13);color:var(--up);border:1px solid rgba(63,185,80,.27)}
.vch.sell{background:rgba(248,81,73,.13);color:var(--dn);border:1px solid rgba(248,81,73,.27)}
.vch.hold{background:rgba(255,179,0,.13);color:#ffb300;border:1px solid rgba(255,179,0,.27)}
.vch.watch{background:rgba(124,58,237,.13);color:#a78bfa;border:1px solid rgba(124,58,237,.27)}
.vch.low{background:rgba(63,185,80,.1);color:var(--up);border:1px solid rgba(63,185,80,.2)}
.vch.mid{background:rgba(255,179,0,.1);color:#ffb300;border:1px solid rgba(255,179,0,.2)}
.vch.high{background:rgba(248,81,73,.1);color:var(--dn);border:1px solid rgba(248,81,73,.2)}
.tr{display:flex;gap:9px;flex-wrap:wrap;margin:11px 0}
.tb2{flex:1;min-width:105px;background:var(--bg3);border-radius:10px;padding:13px;text-align:center}
.tl{font-family:var(--fm);font-size:.6rem;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.tv{font-family:var(--fm);font-size:.97rem;font-weight:700}
.tb2.b .tv{color:var(--up)}.tb2.d .tv{color:var(--dn)}.tb2.s .tv{color:var(--ac2)}.tb2.t .tv{color:var(--acc)}
.rr{display:flex;align-items:center;gap:10px;margin:11px 0}
.rl{font-family:var(--fm);font-size:.7rem;color:var(--tx2);width:52px}
.rt{flex:1;height:7px;background:var(--bg3);border-radius:100px;overflow:hidden}
.rf{height:100%;border-radius:100px;transition:width 1.3s ease}
.rf.low{background:var(--up)}.rf.mid{background:#ffb300}.rf.high{background:var(--dn)}
.rp{font-family:var(--fm);font-size:.7rem;color:var(--tx2);width:32px;text-align:right}

/* â”€â”€ POPULAR â”€â”€ */
.ps{margin-top:58px}
.ps-lbl{font-family:var(--fm);font-size:.7rem;letter-spacing:3px;text-transform:uppercase;color:var(--tx3);margin-bottom:16px}
.pg{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:12px}
.pc2{background:var(--bg2);border:1px solid var(--brd);border-radius:var(--r);padding:18px;cursor:pointer;transition:border-color .2s,transform .2s,box-shadow .2s;position:relative;overflow:hidden}
.pc2::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(to right,var(--acc),var(--ac3));transform:scaleX(0);transition:transform .3s}
.pc2:hover{border-color:rgba(0,212,170,.46);transform:translateY(-3px);box-shadow:0 10px 26px rgba(0,0,0,.4)}.pc2:hover::after{transform:scaleX(1)}
.psym{font-family:var(--fm);font-size:.68rem;color:var(--tx3);margin-bottom:4px}
.pn{font-weight:700;font-size:.9rem;margin-bottom:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pp{font-family:var(--fm);font-size:1.06rem;font-weight:700;margin-bottom:3px}
.pch{font-family:var(--fm);font-size:.77rem;font-weight:700}
.pch.up{color:var(--up)}.pch.dn{color:var(--dn)}.pch.na{color:var(--tx3)}
.psk{height:116px;border-radius:var(--r);border:1px solid var(--brd);background:linear-gradient(90deg,var(--bg2) 0%,var(--bg3) 50%,var(--bg2) 100%);background-size:200% 100%;animation:sh 1.4s infinite}
@keyframes sh{to{background-position:-200% 0}}

/* â”€â”€ FOOTER â”€â”€ */
footer{text-align:center;padding:28px 24px;border-top:1px solid var(--brd);color:var(--tx3);font-size:.76rem;position:relative;z-index:1;line-height:2.1}
.fs{font-family:var(--fm);font-size:.67rem}

/* TOAST */
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:#0d1117;border:1px solid var(--dn);color:var(--dn);padding:12px 24px;border-radius:12px;font-size:.86rem;z-index:9999;box-shadow:0 8px 28px rgba(0,0,0,.6);max-width:88vw;text-align:center;line-height:1.6;animation:fu .3s ease}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
@media(max-width:560px){header{padding:0 14px}main{padding:0 14px 56px}.hero{padding:42px 0 34px}.rh,.ap{padding:16px}.pm{font-size:1.9rem}#btn{padding:12px 14px;font-size:.83rem}}
</style>
</head>
<body>

<header>
  <div class="logo">STOCK<span>MIND</span></div>
  <div class="tb">
    <div class="tb-track" id="tbTrack"><span class="ti-ph">ì‹œì¥ ë°ì´í„° ë¡œë”© ì¤‘...</span></div>
  </div>
</header>

<main>
  <section class="hero">
    <div class="hero-badge">AI ì£¼ì‹ ë¶„ì„ í”Œë«í¼</div>
    <h1>ì£¼ì‹ì„ ê²€ìƒ‰í•˜ê³ <br/><em>AIì˜ ëˆˆ</em>ìœ¼ë¡œ ë³´ë¼</h1>
    <p class="hero-sub">ì½”ìŠ¤í”¼ Â· ì½”ìŠ¤ë‹¥ Â· ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ë¶„ì„<br/>ì–¸ì œ ì‚¬ê³  íŒ”ì§€, AIê°€ êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</p>
    <div class="sw">
      <div class="sb">
        <svg class="si" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input id="q" type="text" placeholder="ì‚¼ì„±ì „ì, AAPL, ì¹´ì¹´ì˜¤, Tesla, 005930..." autocomplete="off" spellcheck="false"/>
        <button id="btn">ë¶„ì„í•˜ê¸°</button>
      </div>
      <div id="sug"></div>
    </div>
    <div class="chips">
      <button class="chip on">ì „ì²´</button>
      <button class="chip">KOSPI</button>
      <button class="chip">KOSDAQ</button>
      <button class="chip">ë¯¸êµ­</button>
    </div>
  </section>

  <!-- ìƒíƒœ ë°°ë„ˆ -->
  <div id="banner"></div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ -->
  <section class="rs" id="rs" style="display:none">
    <div class="rh">
      <div class="rm"><span class="rm-mkt" id="rMkt"></span><span class="rm-time" id="rTime"></span></div>
      <div class="rn"><h2 id="rName"></h2><span class="rbadge" id="rTicker"></span></div>
      <div class="pb"><span class="pm" id="rPrice"></span><span class="pc" id="rChange"></span></div>
    </div>
    <div class="dg">
      <div class="cc"><div class="cl">ê°€ê²© ì°¨íŠ¸ (ìµœê·¼ 30ì¼)</div><canvas id="mychart"></canvas></div>
      <div class="sc"><div class="cl">í•µì‹¬ ì§€í‘œ</div><div class="sg2" id="stats"></div></div>
    </div>
    <div class="ap">
      <div class="ah">
        <div class="ab">
          <svg viewBox="0 0 24 24" fill="currentColor" width="17" height="17"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          AI ë¶„ì„ ë¦¬í¬íŠ¸
        </div>
        <span class="at2">Claude AI</span>
      </div>
      <div class="al" id="aLoad"><div class="sp"></div><span>AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span></div>
      <div id="aCont" style="display:none"></div>
    </div>
  </section>

  <!-- ì¸ê¸° ì¢…ëª© -->
  <section class="ps">
    <div class="ps-lbl">ì¸ê¸° ì¢…ëª©</div>
    <div class="pg" id="pg">
      <div class="psk"></div><div class="psk"></div><div class="psk"></div>
      <div class="psk"></div><div class="psk"></div><div class="psk"></div>
    </div>
  </section>
</main>

<footer>
  <p>StockMind AI Â· íˆ¬ìëŠ” ë³¸ì¸ ì±…ì„ì…ë‹ˆë‹¤ Â· ì •ë³´ ì œê³µ ëª©ì ì´ë©° íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤</p>
  <p class="fs">Naver Finance Â· Yahoo Finance Â· Claude AI Â· Cloudflare Pages Worker</p>
</footer>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   StockMind AI â€” í”„ë¡ íŠ¸ì—”ë“œ
   ëª¨ë“  API í˜¸ì¶œì€ /api/... (ê°™ì€ ë„ë©”ì¸, _worker.jsê°€ ì²˜ë¦¬)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ ì¢…ëª© DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DB = [
  {c:'005930.KS',m:'KOSPI', n:'ì‚¼ì„±ì „ì',        e:'Samsung Electronics'},
  {c:'000660.KS',m:'KOSPI', n:'SKí•˜ì´ë‹‰ìŠ¤',       e:'SK Hynix'},
  {c:'035420.KS',m:'KOSPI', n:'NAVER',            e:'NAVER Corp'},
  {c:'035720.KS',m:'KOSPI', n:'ì¹´ì¹´ì˜¤',           e:'Kakao'},
  {c:'005380.KS',m:'KOSPI', n:'í˜„ëŒ€ìë™ì°¨',       e:'Hyundai Motor'},
  {c:'000270.KS',m:'KOSPI', n:'ê¸°ì•„',             e:'Kia'},
  {c:'051910.KS',m:'KOSPI', n:'LGí™”í•™',           e:'LG Chem'},
  {c:'005490.KS',m:'KOSPI', n:'POSCOí™€ë”©ìŠ¤',      e:'POSCO Holdings'},
  {c:'207940.KS',m:'KOSPI', n:'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', e:'Samsung Biologics'},
  {c:'068270.KS',m:'KOSPI', n:'ì…€íŠ¸ë¦¬ì˜¨',         e:'Celltrion'},
  {c:'323410.KS',m:'KOSPI', n:'ì¹´ì¹´ì˜¤ë±…í¬',       e:'KakaoBank'},
  {c:'259960.KS',m:'KOSPI', n:'í¬ë˜í”„í†¤',         e:'Krafton'},
  {c:'352820.KS',m:'KOSPI', n:'í•˜ì´ë¸Œ',           e:'HYBE'},
  {c:'036570.KS',m:'KOSPI', n:'ì—”ì”¨ì†Œí”„íŠ¸',       e:'NCSoft'},
  {c:'251270.KS',m:'KOSPI', n:'ë„·ë§ˆë¸”',           e:'Netmarble'},
  {c:'090430.KS',m:'KOSPI', n:'ì•„ëª¨ë ˆí¼ì‹œí”½',     e:'AmorePacific'},
  {c:'030200.KS',m:'KOSPI', n:'KT',              e:'KT Corp'},
  {c:'017670.KS',m:'KOSPI', n:'SKí…”ë ˆì½¤',         e:'SK Telecom'},
  {c:'066570.KS',m:'KOSPI', n:'LGì „ì',           e:'LG Electronics'},
  {c:'055550.KS',m:'KOSPI', n:'ì‹ í•œì§€ì£¼',         e:'Shinhan Financial'},
  {c:'034020.KS',m:'KOSPI', n:'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°',   e:'Doosan Enerbility'},
  {c:'015760.KS',m:'KOSPI', n:'í•œêµ­ì „ë ¥',         e:'Korea Electric Power'},
  {c:'105560.KS',m:'KOSPI', n:'KBê¸ˆìœµ',           e:'KB Financial'},
  {c:'086790.KS',m:'KOSPI', n:'í•˜ë‚˜ê¸ˆìœµì§€ì£¼',     e:'Hana Financial'},
  {c:'003550.KS',m:'KOSPI', n:'LG',              e:'LG Corp'},
  {c:'032830.KS',m:'KOSPI', n:'ì‚¼ì„±ìƒëª…',         e:'Samsung Life'},
  {c:'015360.KS',m:'KOSPI', n:'ì´ê±´í™€ë”©ìŠ¤',       e:'Ikon Holdings'},
  {c:'000810.KS',m:'KOSPI', n:'ì‚¼ì„±í™”ì¬',         e:'Samsung Fire'},
  {c:'003490.KS',m:'KOSPI', n:'ëŒ€í•œí•­ê³µ',         e:'Korean Air'},
  {c:'000100.KS',m:'KOSPI', n:'ìœ í•œì–‘í–‰',         e:'Yuhan Corp'},
  {c:'009150.KS',m:'KOSPI', n:'ì‚¼ì„±ì „ê¸°',         e:'Samsung Electro'},
  {c:'010130.KS',m:'KOSPI', n:'ê³ ë ¤ì•„ì—°',         e:'Korea Zinc'},
  {c:'028260.KS',m:'KOSPI', n:'ì‚¼ì„±ë¬¼ì‚°',         e:'Samsung C&T'},
  {c:'012330.KS',m:'KOSPI', n:'í˜„ëŒ€ëª¨ë¹„ìŠ¤',       e:'Hyundai Mobis'},
  {c:'247540.KQ',m:'KOSDAQ',n:'ì—ì½”í”„ë¡œë¹„ì— ',     e:'EcoPro BM'},
  {c:'086520.KQ',m:'KOSDAQ',n:'ì—ì½”í”„ë¡œ',         e:'EcoPro'},
  {c:'091990.KQ',m:'KOSDAQ',n:'ì…€íŠ¸ë¦¬ì˜¨í—¬ìŠ¤ì¼€ì–´', e:'Celltrion Healthcare'},
  {c:'293490.KQ',m:'KOSDAQ',n:'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ',     e:'Kakao Games'},
  {c:'263750.KQ',m:'KOSDAQ',n:'í„ì–´ë¹„ìŠ¤',         e:'Pearl Abyss'},
  {c:'041510.KQ',m:'KOSDAQ',n:'ì—ìŠ¤ì— ',           e:'SM Entertainment'},
  {c:'AAPL',     m:'NASDAQ', n:'Apple',           e:'Apple Inc'},
  {c:'MSFT',     m:'NASDAQ', n:'Microsoft',       e:'Microsoft Corp'},
  {c:'GOOGL',    m:'NASDAQ', n:'Alphabet',        e:'Alphabet Inc'},
  {c:'AMZN',     m:'NASDAQ', n:'Amazon',          e:'Amazon.com'},
  {c:'NVDA',     m:'NASDAQ', n:'NVIDIA',          e:'NVIDIA Corp'},
  {c:'META',     m:'NASDAQ', n:'Meta',            e:'Meta Platforms'},
  {c:'TSLA',     m:'NASDAQ', n:'Tesla',           e:'Tesla Inc'},
  {c:'TSM',      m:'NYSE',   n:'TSMC',           e:'Taiwan Semiconductor'},
  {c:'AVGO',     m:'NASDAQ', n:'Broadcom',        e:'Broadcom Inc'},
  {c:'NFLX',     m:'NASDAQ', n:'Netflix',         e:'Netflix Inc'},
  {c:'AMD',      m:'NASDAQ', n:'AMD',            e:'Advanced Micro Devices'},
  {c:'INTC',     m:'NASDAQ', n:'Intel',          e:'Intel Corp'},
  {c:'DIS',      m:'NYSE',   n:'Disney',         e:'Walt Disney'},
  {c:'JPM',      m:'NYSE',   n:'JP Morgan',      e:'JPMorgan Chase'},
  {c:'V',        m:'NYSE',   n:'Visa',          e:'Visa Inc'},
  {c:'WMT',      m:'NYSE',   n:'Walmart',        e:'Walmart Inc'},
  {c:'COIN',     m:'NASDAQ', n:'Coinbase',        e:'Coinbase Global'},
  {c:'PLTR',     m:'NASDAQ', n:'Palantir',        e:'Palantir Technologies'},
  {c:'ARM',      m:'NASDAQ', n:'Arm Holdings',    e:'Arm Holdings'},
  {c:'UBER',     m:'NYSE',   n:'Uber',           e:'Uber Technologies'},
  {c:'ORCL',     m:'NYSE',   n:'Oracle',         e:'Oracle Corp'},
  {c:'SMCI',     m:'NASDAQ', n:'Super Micro',     e:'Super Micro Computer'},
];

const ALIAS = {
  'ì‚¼ì„±':'005930.KS','ì‚¼ì„±ì „ì':'005930.KS','samsung':'005930.KS',
  'í•˜ì´ë‹‰ìŠ¤':'000660.KS','skí•˜ì´ë‹‰ìŠ¤':'000660.KS',
  'ë„¤ì´ë²„':'035420.KS','naver':'035420.KS',
  'ì¹´ì¹´ì˜¤':'035720.KS','kakao':'035720.KS',
  'í˜„ëŒ€ì°¨':'005380.KS','í˜„ëŒ€ìë™ì°¨':'005380.KS',
  'ê¸°ì•„':'000270.KS','ê¸°ì•„ì°¨':'000270.KS',
  'ì…€íŠ¸ë¦¬ì˜¨':'068270.KS','ì¹´ì¹´ì˜¤ë±…í¬':'323410.KS',
  'í¬ë˜í”„í†¤':'259960.KS','í•˜ì´ë¸Œ':'352820.KS',
  'ì—”ì”¨':'036570.KS','ì—”ì”¨ì†Œí”„íŠ¸':'036570.KS','ë„·ë§ˆë¸”':'251270.KS',
  'kt':'030200.KS','skt':'017670.KS','skí…”ë ˆì½¤':'017670.KS',
  'lgì „ì':'066570.KS','lg':'003550.KS',
  'ì‹ í•œ':'055550.KS','kb':'105560.KS','kbê¸ˆìœµ':'105560.KS',
  'í•œì „':'015760.KS','í•œêµ­ì „ë ¥':'015760.KS',
  'ì´ê±´í™€ë”©ìŠ¤':'015360.KS','ì´ê±´':'015360.KS',
  'ì—ì½”í”„ë¡œë¹„ì— ':'247540.KQ','ì—ì½”í”„ë¡œ':'086520.KQ',
  'nvidia':'NVDA','ì—”ë¹„ë””ì•„':'NVDA','tesla':'TSLA','í…ŒìŠ¬ë¼':'TSLA',
  'apple':'AAPL','ì• í”Œ':'AAPL','microsoft':'MSFT','ë§ˆì´í¬ë¡œì†Œí”„íŠ¸':'MSFT',
  'google':'GOOGL','êµ¬ê¸€':'GOOGL','amazon':'AMZN','ì•„ë§ˆì¡´':'AMZN',
  'meta':'META','ë©”íƒ€':'META','netflix':'NFLX','ë„·í”Œë¦­ìŠ¤':'NFLX',
  'intel':'INTC','ì¸í…”':'INTC','disney':'DIS','ë””ì¦ˆë‹ˆ':'DIS',
};

/* â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);
const isKR = s => s.endsWith('.KS') || s.endsWith('.KQ');

function fn(v, d=2) {
  const n = parseFloat(String(v||0).replace(/,/g,''));
  return (!isFinite(n)||n===0) ? 'N/A' : n.toLocaleString('ko-KR',{maximumFractionDigits:d});
}
function fp(v, kr) {
  const n = parseFloat(String(v||0).replace(/,/g,''));
  return (!isFinite(n)||n===0) ? 'N/A' : kr ? fn(n,0)+'ì›' : '$'+fn(n,n>=100?2:4);
}
function fpc(v) {
  const n = parseFloat(v||0);
  return !isFinite(n) ? '' : (n>=0?'+':'')+n.toFixed(2)+'%';
}
function fcap(v, kr) {
  if (!v||v<=0) return 'N/A';
  return kr ? (v>=1e12?fn(v/1e12,1)+'ì¡°ì›':fn(v/1e8,0)+'ì–µì›') : '$'+fn(v/1e9,1)+'B';
}
function resolve(raw) {
  const q=raw.trim(), lq=q.toLowerCase().replace(/\s+/g,'');
  const a=ALIAS[lq];
  if (a) return {sym:a, info:DB.find(d=>d.c===a)};
  const hit=DB.find(d=>d.n.replace(/\s/g,'').toLowerCase()===lq||d.e.replace(/\s/g,'').toLowerCase()===lq||d.c.toLowerCase()===lq);
  if (hit) return {sym:hit.c, info:hit};
  if (/^\d{6}$/.test(q)) { const s=q+'.KS'; return {sym:s, info:DB.find(d=>d.c===s)}; }
  const u=q.toUpperCase(); return {sym:u, info:DB.find(d=>d.c===u)};
}

/* â”€â”€ Worker API í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let workerOk = null; // null=ë¯¸í™•ì¸, true=OK, false=ì—†ìŒ

async function apiStock(params) {
  const qs  = new URLSearchParams(params).toString();
  const res = await fetch(`/api/stock?${qs}`);
  const ct  = res.headers.get('content-type') || '';

  if (!ct.includes('json')) {
    workerOk = false;
    showBanner('err',
      'âš  _worker.js ë¯¸ì‘ë‹µ',
      `GitHub ë£¨íŠ¸ì— <code>_worker.js</code> íŒŒì¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br/>
       íŒŒì¼ì´ ì—†ê±°ë‚˜ ë°°í¬ê°€ ì•„ì§ ì•ˆ ëœ ê²½ìš°ì…ë‹ˆë‹¤.<br/>
       <a href="/api/health" target="_blank" style="color:var(--acc)">â†’ /api/health í™•ì¸</a>`
    );
    throw new Error('Worker ì—†ìŒ â€” GitHub ë£¨íŠ¸ì— _worker.js íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”');
  }

  const j = await res.json();
  if (!j.ok) throw new Error(j.error || 'ë°ì´í„° ì—†ìŒ');
  workerOk = true;
  $('banner').style.display = 'none';
  return j;
}

function showBanner(type, title, body) {
  const b = $('banner');
  b.className = type;
  b.innerHTML = `<h3>${title}</h3><p>${body}</p>`;
  b.style.display = 'block';
}

/* â”€â”€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let CI = null;
function drawChart(hist, kr) {
  const labels = hist.map(h => { const p=h.date.split('-'); return p.length===3?`${+p[1]}/${+p[2]}`:h.date; });
  const prices = hist.map(h => h.close).filter(Boolean);
  if (!prices.length) return;
  const ctx = $('mychart').getContext('2d');
  if (CI) CI.destroy();
  const up=prices[prices.length-1]>=prices[0], col=up?'#3fb950':'#f85149';
  CI = new Chart(ctx, {
    type:'line',
    data:{labels,datasets:[{data:prices,borderColor:col,borderWidth:2.5,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:col,fill:true,tension:0.36,
      backgroundColor:c=>{const g=c.chart.ctx.createLinearGradient(0,0,0,240);g.addColorStop(0,up?'rgba(63,185,80,.25)':'rgba(248,81,73,.25)');g.addColorStop(1,'rgba(0,0,0,0)');return g;}}]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:false},tooltip:{backgroundColor:'#0d1117',borderColor:'#21262d',borderWidth:1,titleColor:'#8b949e',bodyColor:'#e6edf3',bodyFont:{family:'JetBrains Mono',size:11},padding:10,
        callbacks:{label:c=>' '+(kr?fn(c.parsed.y,0)+'ì›':'$'+fn(c.parsed.y,2))}}},
      scales:{x:{grid:{color:'rgba(33,38,45,.7)'},ticks:{color:'#484f58',maxTicksLimit:8,font:{family:'JetBrains Mono',size:11}}},
              y:{grid:{color:'rgba(33,38,45,.7)'},ticks:{color:'#484f58',font:{family:'JetBrains Mono',size:11},callback:v=>kr?fn(v,0):'$'+fn(v,0)}}}}},
  });
}

/* â”€â”€ AI ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildPrompt(sd) {
  const vals=sd.prices.filter(Boolean), mx=vals.length?Math.max(...vals):0, mn=vals.length?Math.min(...vals):0;
  const vol=mn>0?(((mx-mn)/mn)*100).toFixed(1):0;
  const trend=vals.length>=2?(vals[vals.length-1]>vals[0]?'ìƒìŠ¹':'í•˜ë½'):'ë³´í•©';
  const rec=vals.slice(-10).map((v,i)=>`D${i+1}:${Number(v).toFixed(2)}`).join(', ');
  return `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì£¼ì‹ ì• ë„ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.

ì¢…ëª©: ${sd.name} (${sd.sym}) | ì‹œì¥: ${sd.mkt} | í˜„ì¬ê°€: ${sd.priceRaw} | ë“±ë½: ${sd.chgPct}%
52ì£¼ê³ ê°€: ${sd.h52} | 52ì£¼ì €ê°€: ${sd.l52} | ê±°ë˜ëŸ‰: ${sd.vol} | ì‹œê°€ì´ì•¡: ${sd.mktcap} | PER: ${sd.per}
ìµœê·¼10ì¼: ${rec} | íŠ¸ë Œë“œ: ${trend} | ë³€ë™ì„±: ${vol}%

JSON:
{"verdict":"ë§¤ìˆ˜|ë§¤ë„|ê´€ë§|ì£¼ëª©","verdictReason":"3~4ë¬¸ì¥","buyStrategy":{"zone":"êµ¬ê°„","timing":"íƒ€ì´ë°","split":["1ì°¨","2ì°¨"]},"sellStrategy":{"shortTarget":"ë‹¨ê¸°","midTarget":"ì¤‘ê¸°","stopLoss":"ì†ì ˆ","exitSignal":"ìµì ˆì‹ í˜¸"},"risks":["ë¦¬1","ë¦¬2","ë¦¬3"],"riskLevel":"ë‚®ìŒ|ì¤‘ê°„|ë†’ìŒ","riskScore":40,"scenarios":{"bull":{"price":"ë‚™ê´€","desc":"ì„¤ëª…"},"base":{"price":"ì¤‘ë¦½","desc":"ì„¤ëª…"},"bear":{"price":"ë¹„ê´€","desc":"ì„¤ëª…"}},"watchPoints":["í¬1","í¬2","í¬3"],"summary":"2ë¬¸ì¥"}`;
}

async function callAI(sd) {
  const r = await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:buildPrompt(sd)})});
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('json')) throw new Error('AI Worker ë¯¸ì‘ë‹µ');
  if (!r.ok) throw new Error('AI ì˜¤ë¥˜ '+r.status);
  return r.json();
}

function renderAI(r) {
  const vc={ë§¤ìˆ˜:'buy',ë§¤ë„:'sell',ê´€ë§:'hold',ì£¼ëª©:'watch'}[r.verdict]||'hold';
  const sc=Math.min(100,Math.max(0,r.riskScore||50)), rc=sc<35?'low':sc<65?'mid':'high';
  $('aCont').innerHTML=`
    <div class="as"><div class="ast">ì¢…í•© íˆ¬ì ì˜ê²¬</div>
      <div class="vc"><span class="vch ${vc}">${r.verdict||'ê´€ë§'}</span><span class="vch ${rc}">ë¦¬ìŠ¤í¬ ${r.riskLevel||'ì¤‘ê°„'}</span></div>
      <p style="color:#c9d1d9;line-height:1.9;margin-top:12px">${r.verdictReason||r.summary||''}</p>
    </div>
    <div class="as"><div class="ast">ë§¤ìˆ˜ / ë§¤ë„ ì „ëµ</div>
      <div class="tr">
        <div class="tb2 b"><div class="tl">ë§¤ìˆ˜ êµ¬ê°„</div><div class="tv" style="font-size:.8rem">${r.buyStrategy?.zone||'N/A'}</div></div>
        <div class="tb2 d"><div class="tl">ë‹¨ê¸° ëª©í‘œê°€</div><div class="tv">${r.sellStrategy?.shortTarget||'N/A'}</div></div>
        <div class="tb2 t"><div class="tl">ì¤‘ê¸° ëª©í‘œê°€</div><div class="tv">${r.sellStrategy?.midTarget||'N/A'}</div></div>
        <div class="tb2 s"><div class="tl">ì†ì ˆê°€</div><div class="tv">${r.sellStrategy?.stopLoss||'N/A'}</div></div>
      </div>
      ${r.buyStrategy?.split?.length?`<p style="margin-top:8px;color:#8b949e;font-size:.85rem">ë¶„í• ë§¤ìˆ˜: ${r.buyStrategy.split.join(' â†’ ')}</p>`:''}
      ${r.buyStrategy?.timing?`<p style="margin-top:5px;color:#8b949e;font-size:.85rem">íƒ€ì´ë°: ${r.buyStrategy.timing}</p>`:''}
      ${r.sellStrategy?.exitSignal?`<p style="margin-top:5px;color:#8b949e;font-size:.85rem">ìµì ˆ ì‹ í˜¸: ${r.sellStrategy.exitSignal}</p>`:''}
    </div>
    <div class="as"><div class="ast">3ê°œì›” ì‹œë‚˜ë¦¬ì˜¤</div>
      <div class="tr">
        <div class="tb2 b"><div class="tl">ğŸŸ¢ ë‚™ê´€</div><div class="tv">${r.scenarios?.bull?.price||'N/A'}</div><p style="font-size:.75rem;color:#8b949e;margin-top:5px;line-height:1.6">${r.scenarios?.bull?.desc||''}</p></div>
        <div class="tb2 t"><div class="tl">ğŸ”µ ì¤‘ë¦½</div><div class="tv">${r.scenarios?.base?.price||'N/A'}</div><p style="font-size:.75rem;color:#8b949e;margin-top:5px;line-height:1.6">${r.scenarios?.base?.desc||''}</p></div>
        <div class="tb2 s"><div class="tl">ğŸ”´ ë¹„ê´€</div><div class="tv">${r.scenarios?.bear?.price||'N/A'}</div><p style="font-size:.75rem;color:#8b949e;margin-top:5px;line-height:1.6">${r.scenarios?.bear?.desc||''}</p></div>
      </div>
    </div>
    <div class="as"><div class="ast">ë¦¬ìŠ¤í¬ ë¶„ì„</div>
      <div class="rr"><span class="rl">ë¦¬ìŠ¤í¬</span><div class="rt"><div class="rf ${rc}" id="rBar" style="width:0%"></div></div><span class="rp">${sc}%</span></div>
      <ul style="padding-left:19px;margin-top:12px;color:#8b949e;font-size:.87rem;line-height:2.2">
        ${(r.risks||[]).map(x=>`<li><span style="color:#e6edf3">${x}</span></li>`).join('')}
      </ul>
    </div>
    <div class="as"><div class="ast">í•µì‹¬ ê´€ì „ í¬ì¸íŠ¸</div>
      <ol style="padding-left:21px;font-size:.87rem;line-height:2.4">
        ${(r.watchPoints||[]).map(x=>`<li><span style="color:#e6edf3">${x}</span></li>`).join('')}
      </ol>
    </div>`;
  $('aCont').style.display='block';
  $('aLoad').style.display='none';
  setTimeout(()=>{const b=$('rBar');if(b)b.style.width=sc+'%';},100);
}

/* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg) {
  document.querySelectorAll('.toast').forEach(e=>e.remove());
  const el=document.createElement('div');
  el.className='toast';el.textContent='âš  '+msg;
  document.body.appendChild(el);
  setTimeout(()=>el&&el.remove(),7000);
}

/* â”€â”€ ë©”ì¸ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doSearch(raw) {
  const q=raw.trim(); if(!q) return;
  $('rs').style.display='none';
  $('btn').disabled=true; $('btn').textContent='ë¡œë”© ì¤‘...';
  try {
    const {sym,info}=resolve(q), kr=isKR(sym), mkt=info?.m||(kr?'KOSPI':'US MARKET');
    $('btn').textContent='ë°ì´í„° ìˆ˜ì§‘ ì¤‘...';
    const [qData,hData]=await Promise.all([
      apiStock({action:'quote',symbol:sym}),
      apiStock({action:'chart',symbol:sym,days:30}),
    ]);
    const hist=hData.history||[], prices=hist.map(h=>h.close).filter(Boolean);
    const p=qData.price||0, chg=qData.change||0, pct=qData.changePct||0, up=chg>=0;
    const ps=fp(p,kr);
    const cs=(up?'+':'')+(kr?fn(chg,0)+'ì›':(chg>=0?'+$':'-$')+fn(Math.abs(chg),2))+` (${fpc(pct)})`;
    const sd={sym,mkt,name:qData.name||info?.n||sym,priceRaw:p,chgPct:pct,
              h52:fp(qData.high52,kr),l52:fp(qData.low52,kr),
              vol:fn(qData.volume,0),mktcap:fcap(qData.marketCap,kr),per:fn(qData.per,1),prices};

    $('rMkt').textContent=mkt;
    $('rTime').textContent='ì‹¤ì‹œê°„ Â· '+new Date().toLocaleTimeString('ko-KR');
    $('rName').textContent=sd.name;
    $('rTicker').textContent=sym;
    $('rPrice').textContent=ps;
    $('rChange').textContent=cs;
    $('rChange').className='pc '+(up?'up':'dn');
    $('stats').innerHTML=[
      {l:'52ì£¼ ê³ ê°€',v:sd.h52},{l:'52ì£¼ ì €ê°€',v:sd.l52},
      {l:'ê±°ë˜ëŸ‰',v:sd.vol},{l:'ì‹œê°€ì´ì•¡',v:sd.mktcap},
      {l:'PER',v:sd.per},{l:'ë“±ë½ë¥ ',v:fpc(pct)},
    ].map(x=>`<div class="si2"><div class="sl2">${x.l}</div><div class="sv">${x.v}</div></div>`).join('');

    if (hist.length) drawChart(hist,kr);
    $('rs').style.display='block';
    $('rs').scrollIntoView({behavior:'smooth',block:'start'});

    $('aLoad').style.display='flex'; $('aCont').style.display='none';
    $('btn').textContent='AI ë¶„ì„ ì¤‘...';
    callAI(sd).then(r=>{
      if(r.verdict) renderAI(r);
      else { $('aLoad').style.display='none'; $('aCont').innerHTML='<p style="color:#8b949e">AI ì‘ë‹µ ì—†ìŒ. Cloudflare Pages â†’ Settings â†’ Environment variables ì— <code style="color:#00d4aa">ANTHROPIC_API_KEY</code> ì¶”ê°€ í•„ìš”.</p>'; $('aCont').style.display='block'; }
    }).catch(e=>{
      $('aLoad').style.display='none';
      $('aCont').innerHTML=`<p style="color:#f85149;font-weight:700;margin-bottom:8px">âš  AI ì—°ê²° ì˜¤ë¥˜</p><p style="color:#8b949e;font-size:.85rem">${e.message}</p>`;
      $('aCont').style.display='block';
    });
  } catch(e) { console.error(e); toast(e.message); }
  finally { $('btn').disabled=false; $('btn').textContent='ë¶„ì„í•˜ê¸°'; }
}

/* â”€â”€ ìë™ì™„ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let ST;
function showSug(query) {
  const q=query.trim().toLowerCase().replace(/\s+/g,'');
  if (!q) { hideSug(); return; }
  const hits=[],seen=new Set();
  for (const d of DB) {
    if (seen.has(d.c)) continue;
    if (d.n.replace(/\s/g,'').toLowerCase().includes(q)||d.e.replace(/\s/g,'').toLowerCase().includes(q)||d.c.toLowerCase().includes(q)) {hits.push(d);seen.add(d.c);}
    if (hits.length>=8) break;
  }
  if (!hits.length) { hideSug(); return; }
  const mc={KOSPI:'k',KOSDAQ:'q',NASDAQ:'u',NYSE:'u'};
  $('sug').innerHTML=hits.map(d=>`<div class="sg" data-c="${d.c}"><div><div class="sg-n">${d.n} <span style="color:#484f58;font-size:.74rem">${d.e}</span></div><div class="sg-s">${d.c} Â· ${d.m}</div></div><span class="sg-m ${mc[d.m]||'u'}">${d.m}</span></div>`).join('');
  $('sug').classList.add('open');
  $('sug').querySelectorAll('.sg').forEach(el=>el.addEventListener('click',()=>{const i=DB.find(d=>d.c===el.dataset.c);$('q').value=i?i.n:el.dataset.c;hideSug();doSearch(el.dataset.c);}));
}
function hideSug() { $('sug').classList.remove('open'); }

/* â”€â”€ ì¸ê¸° ì¢…ëª© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const POP=[
  {c:'005930.KS',n:'ì‚¼ì„±ì „ì',  m:'KOSPI' },
  {c:'000660.KS',n:'SKí•˜ì´ë‹‰ìŠ¤',m:'KOSPI' },
  {c:'035420.KS',n:'NAVER',     m:'KOSPI' },
  {c:'NVDA',     n:'NVIDIA',    m:'NASDAQ'},
  {c:'AAPL',     n:'Apple',     m:'NASDAQ'},
  {c:'TSLA',     n:'Tesla',     m:'NASDAQ'},
];
async function loadPop() {
  const pg=$('pg');
  pg.innerHTML=POP.map(()=>'<div class="psk"></div>').join('');
  const res=await Promise.allSettled(POP.map(p=>apiStock({action:'quote',symbol:p.c})));
  pg.innerHTML=POP.map((p,i)=>{
    const r=res[i], kr=isKR(p.c);
    if (r.status==='rejected') return `<div class="pc2" data-c="${p.c}"><div class="psym">${p.c}Â·${p.m}</div><div class="pn">${p.n}</div><div class="pp" style="color:#484f58">â€”</div><div class="pch na">ë°ì´í„° ì—†ìŒ</div></div>`;
    const q=r.value, up=(q.changePct||0)>=0;
    return `<div class="pc2" data-c="${p.c}"><div class="psym">${p.c}Â·${p.m}</div><div class="pn">${q.name||p.n}</div><div class="pp">${fp(q.price,kr)}</div><div class="pch ${up?'up':'dn'}">${fpc(q.changePct)}</div></div>`;
  }).join('');
  pg.querySelectorAll('.pc2').forEach(el=>el.addEventListener('click',()=>doSearch(el.dataset.c)));
}

/* â”€â”€ í‹°ì»¤ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadTicker() {
  const T=[
    {c:'005930.KS',n:'ì‚¼ì„±ì „ì'},{c:'000660.KS',n:'SKí•˜ì´ë‹‰ìŠ¤'},
    {c:'035420.KS',n:'NAVER'},{c:'NVDA',n:'NVIDIA'},
    {c:'AAPL',n:'Apple'},{c:'TSLA',n:'Tesla'},
    {c:'MSFT',n:'Microsoft'},{c:'035720.KS',n:'ì¹´ì¹´ì˜¤'},
  ];
  const res=await Promise.allSettled(T.map(t=>apiStock({action:'quote',symbol:t.c})));
  const items=T.map((t,i)=>{const r=res[i];if(r.status==='rejected')return null;return{...t,price:r.value.price,pct:r.value.changePct,kr:isKR(t.c)};}).filter(Boolean);
  if (!items.length) { $('tbTrack').innerHTML='<span class="ti-ph">_worker.js ë°°í¬ í›„ ì´ìš© ê°€ëŠ¥</span>'; return; }
  const html=()=>items.map(t=>{const up=(t.pct||0)>=0,ps=t.kr?fn(t.price,0)+'ì›':'$'+fn(t.price,2);return `<span class="ti" data-c="${t.c}"><b>${t.n}</b>${ps}<span class="${up?'tu':'td'}">${fpc(t.pct)}</span></span>`;}).join('');
  const track=$('tbTrack'); track.innerHTML=html()+html();
  track.querySelectorAll('.ti').forEach(el=>el.addEventListener('click',()=>doSearch(el.dataset.c)));
}

/* â”€â”€ ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('btn').addEventListener('click',()=>doSearch($('q').value));
$('q').addEventListener('keydown',e=>{if(e.key==='Enter'){hideSug();doSearch($('q').value);}if(e.key==='Escape')hideSug();});
$('q').addEventListener('input',e=>{clearTimeout(ST);ST=setTimeout(()=>showSug(e.target.value),130);});
document.addEventListener('click',e=>{if(!e.target.closest('.sw'))hideSug();});
document.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>{document.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));c.classList.add('on');}));

/* â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async () => {
  try {
    const r  = await fetch('/api/health');
    const ct = r.headers.get('content-type')||'';
    if (!ct.includes('json')) {
      showBanner('err','âš  _worker.js ë¯¸ë°°í¬',
        'GitHub ë£¨íŠ¸ì— <code>_worker.js</code> íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.<br/>ì˜¬ë¦° í›„ Cloudflareê°€ ìë™ ì¬ë°°í¬í•©ë‹ˆë‹¤ (ì•½ 1ë¶„ ì†Œìš”).<br/><a href="/api/health" target="_blank" style="color:var(--acc)">â†’ /api/healthë¡œ í™•ì¸</a>');
    } else {
      const j = await r.json();
      if (!j.ok) throw new Error();
      // Worker ì •ìƒ â€” ë°°ë„ˆ ìˆ¨ê¹€
      $('banner').style.display='none';
    }
  } catch {
    showBanner('err','âš  _worker.js ë¯¸ë°°í¬',
      'GitHub ë£¨íŠ¸ì— <code>_worker.js</code> íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.<br/>ì˜¬ë¦° í›„ Cloudflareê°€ ìë™ ì¬ë°°í¬í•©ë‹ˆë‹¤.');
  }
  await Promise.allSettled([loadTicker(), loadPop()]);
})();
</script>
</body>
</html>
