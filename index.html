<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ğŸ“ˆ KRX AI ë§¤ë§¤ ì „ëµ ë¶„ì„ê¸°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<!-- CSV íŒŒì„œ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f3f4f6;
  margin:0;
  padding:20px;
}

h1{text-align:center;margin-bottom:30px}

.controls{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-bottom:20px;
}

input,select{
  padding:10px;
  font-size:14px;
}

.metrics{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin:20px 0;
}

.card{
  background:white;
  padding:20px;
  border-radius:10px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}

.value{
  font-size:22px;
  font-weight:bold;
  margin-top:5px;
}

#chart{
  height:650px;
}

.analysis{
  background:white;
  padding:20px;
  margin-top:20px;
  border-radius:10px;
}
</style>
</head>


<body>

<h1>ğŸ“ˆ KRX AI ë§¤ë§¤ ì „ëµ ë¶„ì„ê¸°</h1>

<div class="controls">
  <input id="search" placeholder="ì¢…ëª© ê²€ìƒ‰">
  <select id="tickerSelect"></select>
  <button onclick="loadStock()">ë¶„ì„</button>
</div>

<div class="metrics">
  <div class="card">í˜„ì¬ê°€<div class="value" id="current"></div></div>
  <div class="card">ë§¤ìˆ˜ ì¶”ì²œê°€<div class="value" id="buy"></div></div>
  <div class="card">ì†ì ˆ<div class="value" id="stop"></div></div>
  <div class="card">ëª©í‘œ<div class="value" id="target"></div></div>
</div>

<div id="chart"></div>

<div class="analysis" id="analysis"></div>



<script>
// ======================================
// 1. CSV ë¡œë“œ (korea_stocks.csv í•„ìš”)
// ======================================

let stocks = []

Papa.parse("korea_stocks.csv", {
  download:true,
  header:true,
  complete:(res)=>{
    stocks = res.data
    updateOptions()
  }
})

const select = document.getElementById("tickerSelect")

function updateOptions(){
  select.innerHTML=""
  stocks.forEach(s=>{
    const opt=document.createElement("option")
    opt.value=s.ticker
    opt.textContent=`${s.íšŒì‚¬ëª…} (${s.ticker})`
    select.appendChild(opt)
  })
}

document.getElementById("search").oninput=(e)=>{
  const q=e.target.value.toLowerCase()
  const filtered=stocks.filter(s=>s.search.includes(q))
  select.innerHTML=""
  filtered.forEach(s=>{
    const opt=document.createElement("option")
    opt.value=s.ticker
    opt.textContent=`${s.íšŒì‚¬ëª…} (${s.ticker})`
    select.appendChild(opt)
  })
}


// ======================================
// 2. Yahoo Finance fetch
// ======================================

async function loadStock(){

  const ticker=select.value

  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=2y&interval=1d`

  const res=await fetch(url)
  const data=await res.json()

  const result=data.chart.result[0]

  const t=result.timestamp
  const close=result.indicators.quote[0].close
  const volume=result.indicators.quote[0].volume

  const dates=t.map(x=>new Date(x*1000))

  makeStrategy(dates,close,volume)
}


// ======================================
// 3. ì „ëµ ê³„ì‚° (Python ë¡œì§ ë™ì¼)
// ======================================

function rollingMean(arr,n){
  return arr.map((_,i)=>{
    if(i<n) return null
    const slice=arr.slice(i-n,i)
    return slice.reduce((a,b)=>a+b,0)/n
  })
}

function std(arr){
  const m=arr.reduce((a,b)=>a+b)/arr.length
  return Math.sqrt(arr.map(x=>(x-m)**2).reduce((a,b)=>a+b)/arr.length)
}

function makeStrategy(dates,close,volume){

  const current=close.at(-1)

  const ma20=rollingMean(close,20).at(-1)
  const ma60=rollingMean(close,60).at(-1)

  const returns=close.slice(1).map((v,i)=>v/close[i]-1)
  const vol=std(returns)

  const buy=ma20*0.98
  const stop=buy*(1-vol*3)
  const target=buy*1.2

  updateUI(current,buy,stop,target,ma20,ma60,vol,dates,close)
}


// ======================================
// 4. UI ì—…ë°ì´íŠ¸
// ======================================

function fmt(x){return x.toLocaleString("ko-KR",{maximumFractionDigits:0})}

function updateUI(current,buy,stop,target,ma20,ma60,vol,dates,close){

  currentEl.textContent=fmt(current)
  buyEl.textContent=fmt(buy)
  stopEl.textContent=fmt(stop)
  targetEl.textContent=fmt(target)

  analysis.innerHTML=`
  <h3>ğŸ¤– AI ì „ëµ ë¶„ì„</h3>
  ğŸ“‰ ë§¤ìˆ˜ ì¶”ì²œê°€ (${fmt(buy)}ì›)<br>
  â†’ MA20 ì§€ì§€êµ¬ê°„<br><br>

  ğŸ›‘ ì†ì ˆê°€ (${fmt(stop)}ì›)<br>
  â†’ ë³€ë™ì„± ${(vol*100).toFixed(2)}% ê¸°ë°˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬<br><br>

  ğŸ¯ ëª©í‘œê°€ (${fmt(target)}ì›)<br>
  â†’ í‰ê·  íšŒê·€ +20% ì „ëµ<br><br>

  í˜„ì¬ê°€ ${fmt(current)} / MA20 ${fmt(ma20)} / MA60 ${fmt(ma60)}
  `


  const trace={
    x:dates,
    y:close,
    type:"scatter",
    name:"Price"
  }

  Plotly.newPlot("chart",[trace],{
    dragmode:"zoom",
    hovermode:"x unified"
  })
}

</script>

</body>
</html>
